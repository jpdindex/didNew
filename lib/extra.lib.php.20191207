<?php
include_once('./_common.php');
if (!defined('_GNUBOARD_')) exit;

//------------------------------------------------
// JSON 문자열 Decode
//------------------------------------------------
function json_decode_ex($json_str)
{
    $res = array();
    $res['message'] = "";
    $res['result' ] = FALSE;

    $decoded = json_decode(stripslashes($json_str), TRUE);

    switch(json_last_error())
    {
        case JSON_ERROR_DEPTH:
            $res['message'] = 'JSON decode error : Maximum stack depth exceeded';
            break;
        case JSON_ERROR_CTRL_CHAR:
            $res['message'] = 'JSON decode error : Unexpected control character found';
            break;
        case JSON_ERROR_SYNTAX:
            $res['message'] = 'JSON decode error : Syntax error, malformed JSON';
            break;
        case JSON_ERROR_UTF8:
            $res['message'] = 'JSON decode error : JSON_ERROR_UTF8';
            break;
        case JSON_ERROR_STATE_MISMATCH:
            $res['message'] = 'JSON decode error : JSON_ERROR_STATE_MISMATCH';
            break;
        case JSON_ERROR_NONE:
            $res['result'] = $decoded;
            break;
    }

    return $res;
}

//------------------------------------------------
// 업로드 파일 정보
//------------------------------------------------
function upload_info($up_id)
{
    global $g5;

    if (empty($up_id))
    {
        $_SESSION['callfunc_message'] = "업로드 ID가 전달되지 않았습니다.";
        return FALSE;
    }

    $sql = "
        select *
          from {$g5['upload_table']}
         where up_id = '{$up_id}'
        ";

    return sql_fetch($sql);
}

//------------------------------------------------
// 업로드 파일 삭제
//------------------------------------------------
function upload_delete($up_id)
{
    global $g5;

    if (empty($up_id))
    {
        $_SESSION['callfunc_message'] = "업로드 ID가 전달되지 않았습니다.";
        return FALSE;
    }

    // 기존 업로드 정보 구하기
    $sql = "
        select *
          from {$g5['upload_table']}
         where up_id = '{$up_id}'
        ";
    $upload = sql_fetch($sql);
    if (!$upload)
    {
        $_SESSION['callfunc_message'] = "업로드 정보를 구할 수 없습니다.";
        return FALSE;
    }

    // 원본 파일 삭제
    $fullpath = "{$upload['up_path']}/{$upload['up_file']}";
    if (file_exists($fullpath))
        unlink($fullpath);

    // 썸네일 삭제
    foreach(glob("{$upload['up_path']}/thumb-{$upload['up_id']}_*") as $f){
        unlink($f);
    }

    // 업로드 데이터 삭제
    sql_query(" delete from {$g5['upload_table']} where up_id = '{$up_id}' ");

    return TRUE;
}

//------------------------------------------------
// 현재 세션의 업로드 데이터 정리
//------------------------------------------------
function upload_clean()
{
    global $g5;
    $ss_id = session_id();

    $sql = "
        select *
          from {$g5['upload_table']}
         where up_session = '{$ss_id}'
        ";

    $result = sql_query($sql);
    while ($row = sql_fetch_array($result))
    {
        $fullpath = "{$row['up_path']}/{$row['up_file']}";
        if (file_exists($fullpath))
        {
            unlink($fullpath);
        }

        foreach(glob("{$row['up_path']}/thumb-{$row['up_id']}_*") as $f){
            unlink($f);
        }
    }

    sql_query(" delete from {$g5['upload_table']} where up_session = '{$ss_id}' ");
}

//------------------------------------------------
// GUID 구하기
//------------------------------------------------
function GUIDv4 ($trim = true)
{
    // Windows
    if (function_exists('com_create_guid') === true) {
        if ($trim === true)
            return trim(com_create_guid(), '{}');
        else
            return com_create_guid();
    }

    // OSX/Linux
    if (function_exists('openssl_random_pseudo_bytes') === true) {
        $data = openssl_random_pseudo_bytes(16);
        $data[6] = chr(ord($data[6]) & 0x0f | 0x40);    // set version to 0100
        $data[8] = chr(ord($data[8]) & 0x3f | 0x80);    // set bits 6-7 to 10
        return vsprintf('%s%s-%s-%s-%s-%s%s%s', str_split(bin2hex($data), 4));
    }

    // Fallback (PHP 4.2+)
    mt_srand((double)microtime() * 10000);
    $charid = strtolower(md5(uniqid(rand(), true)));
    $hyphen = chr(45);                  // "-"
    $lbrace = $trim ? "" : chr(123);    // "{"
    $rbrace = $trim ? "" : chr(125);    // "}"
    $guidv4 = $lbrace.
              substr($charid,  0,  8).$hyphen.
              substr($charid,  8,  4).$hyphen.
              substr($charid, 12,  4).$hyphen.
              substr($charid, 16,  4).$hyphen.
              substr($charid, 20, 12).
              $rbrace;
    return $guidv4;
}

//------------------------------------------------
// 팀정보 구하기
//------------------------------------------------
function user_info($u_id, $u_pw)
{
    global $g5;

    $sql = " select a.u_id
                  , a.t_code
                  , b.t_name
                  , a.u_name
               from ff_user a
                  , ff_team b
              where a.t_code = b.t_code
                and u_id = '{$u_id}'
                and u_pw = password('{$u_pw}')
              limit 1
           ";

    return sql_fetch($sql);
}

//------------------------------------------------
// 세션정보 구하기
//------------------------------------------------
function session_check($u_id, $ss_device_id)
{
    global $g5;

    $sql = " select ss_id
               from ff_session
              where u_id = '{$u_id}'
                and ss_device_id = '{$ss_device_id}'
              limit 1
           ";

    $row = sql_fetch($sql);

    if ($row)
        return $row['ss_id'];
    else
        return null;
}

//------------------------------------------------
// 세션정보 구하기
//------------------------------------------------
function session_check_by_id($ss_id, $ss_device_id)
{
    global $g5;

    $sql = " select a.u_id
                  , b.t_code
                  , c.t_name
                  , b.u_name
               from ff_session a
                  , ff_user    b
                  , ff_team    c
              where a.u_id = b.u_id
                and b.t_code = c.t_code
                and ss_id = '{$ss_id}'
                and ss_device_id = '{$ss_device_id}'
              limit 1
           ";

    return sql_fetch($sql);
}

//------------------------------------------------
// 세션정보 생성
//------------------------------------------------
function session_create($u_id, $ss_device_id)
{
    global $g5;

    $ss_id = str_replace("-", "", GUIDv4());

    $sql = " insert into ff_session
                set ss_id        = '{$ss_id       }'
                  , u_id         = '{$u_id        }'
                  , ss_device_id = '{$ss_device_id}'
                  , ss_regdate   = now()
           ";

    sql_query($sql);

    return $ss_id;
}

//------------------------------------------------
// 세션정보 삭제
//------------------------------------------------
function session_remove($ss_id)
{
    global $g5;

    $sql = " delete from ff_session
              where ss_id = '{$ss_id}'
           ";

    sql_query($sql);
}

//------------------------------------------------
// Application 통신 로그
//------------------------------------------------
function call_log($func, $req, $res)
{
    global $g5;

    $req_str = str_replace("'", "''", print_r($req, true));
    $res_str = str_replace("'", "''", print_r($res, true));

    $sql = "
        insert into ff_call_log
           set func     = '{$func   }'
             , request  = '{$req_str}'
             , response = '{$res_str}'
             , datetime = now()
    ";

    sql_query($sql);
}

//------------------------------------------------
// 팀정보 구하기
//------------------------------------------------
function team_info($t_code)
{
    global $g5;

    $sql = " select *
               from {$g5['team_table']}
              where t_code = '{$t_code}'
           ";

    return sql_fetch($sql);
}

//------------------------------------------------
// 선수 목록
//------------------------------------------------
function player_list($h_t_code='', $a_t_code='', $basdt='')
{
    global $g5;

    if ($h_t_code && $a_t_code)
        $where = " and o.t_code in ('{$h_t_code}', '{$a_t_code}') ";

    if (empty($basdt))
        $basdt = date("Y.m.d"); // 기준일자 없으면 현재일 기준

    $sql = "
        select distinct o.p_id
             , o.t_code
             , t.t_name
             , p.p_name
             , o.pt_num p_number
             , power(16, o.pt_pos-1) as p_position
             , 'R' as p_foot
          from ff_player_team o
          join ff_player      p on o.p_id   = p.p_id
          join ff_team        t on t.t_code = o.t_code
         where '{$basdt}' between o.pt_begin and o.pt_end
                {$where}
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $row['p_picture'] = G5_DATA_URL."/player/{$row['p_id']}.png";
        $lst[] = $row;
    }

    return $lst;
}

function player_list_20180828($h_t_code = "", $a_t_code = "")
{
    global $g5;

    if ($h_t_code && $a_t_code)
        $where = "    and (a.t_code = '{$h_t_code}' or a.t_code = '{$a_t_code}')";

    $sql = "
        select a.p_id
             , a.t_code
             , b.t_name
             , a.p_name
             , a.p_number
             , power(16, a.p_position-1) as p_position
             , a.p_foot
          from ff_player a
             , ff_team   b
         where a.t_code = b.t_code
       {$where}
         order by
               a.t_code
             , a.p_position
             , a.p_number
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $row['p_picture'] = G5_DATA_URL."/player/{$row['p_id']}.png";
        $lst[] = $row;
    }

    return $lst;
}

//------------------------------------------------
// 팀별 포메이션 목록
//------------------------------------------------
function formation_list()
{
    global $g5;

    $sql = "
        select *
          from ff_formation
         order by
               fm_order asc
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}

//------------------------------------------------
// DID-Play gm_id 단일 경기
//------------------------------------------------
function dplay_game($gm_id) {
      global $g5;

      $sql = "
          select a.*
          from ff_game a
          where a.gm_id = '{$gm_id}'
      ";

      $row = sql_fetch($sql);
      return $row;
}

//------------------------------------------------
// DID-Play 경기 스케듈 목록
//------------------------------------------------
function dplay_game_schedule_list($month, $league_code)
{
    global $g5;


    if (empty($league_code) || $league_code == '000') {
      $where = "";
    } else {
      $where = " and '{$league_code}' = a.gm_league";
    }

    $sql = "
        select distinct a.gm_id
               , b.gi_id
               , a.gm_date
               , a.gm_league as gm_league_code
               , ifnull(a.gm_state, '000') as gi_state
            from ff_game a
            left outer join ff_game_info b
              on b.gm_id  = a.gm_id
           where a.gm_date like '{$month}%'
                 {$where}
         order by
               gm_date asc
    ";

    $res = sql_query($sql);
    $lst = array();

    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}

function dplay_game_schedule($date, $league_code) {
  global $g5;

  if (empty($league_code) || $league_code=="000") {
    $where = "";
  } else {
    $where = " and '{$league_code}' = a.gm_league";
  }

  $sql = "
      select distinct a.gm_id
           , a.gm_h_t_code
           , a.gm_a_t_code
           , ifnull(a.gm_state, '000') as gi_state
           , c1.t_name gm_h_t_name
           , c2.t_name gm_a_t_name
           , ifnull(a.gi_goal_home, 0) as gi_goal_home
           , ifnull(a.gi_goal_away, 0) as gi_goal_away
           , d.s_name as gi_s_name
           , a.gm_date
           , a.gm_time
           , e.league_name as gm_league_name
           , a.gm_league as gm_league_code
           , a.gm_league
           , a.gm_s_code
           , a.gm_round
        from ff_game      a
           , ff_team      c1
           , ff_team      c2
           , ff_stadium   d
           , ff_league    e
       where a.gm_date = '{$date}'
         {$where}
         and c1.t_code = a.gm_h_t_code
         and c2.t_code = a.gm_a_t_code
         and d.s_code = a.gm_s_code
         and e.league_code = a.gm_league
         order by
               gm_time asc
      ";

      $res = sql_query($sql);
      $lst = array();
      while ($row = sql_fetch_array($res)){
        try{
          $row['gi_h_t_logo'] = G5_DATA_URL."/team/{$row['gm_h_t_code']}.png";
        }catch(Exception $e) {}
          try{
          $row['gi_a_t_logo'] = G5_DATA_URL."/team/{$row['gm_a_t_code']}.png";
        }catch(Exception $e) {}
          $lst[] = $row;
      }

      return $lst;
}

//------------------------------------------------
// DID-Play 경기정보
//------------------------------------------------
function dplay_game_info_for_gmid($gm_id)
{
    global $g5;

    $sql = "
        select a.gi_id
             , b.gm_id
             , a.gi_user_id
             , a.gi_write_code
             , b.gm_h_t_code
             , b.gm_a_t_code
             , a.gi_state
             , a.gi_part
             , a.gi_formation
             , gi_h1_begin
             , gi_h2_begin
             , gi_h3_begin
             , gi_h4_begin
             , a.gi_h1_seconds
             , a.gi_h2_seconds
             , a.gi_h3_seconds
             , a.gi_h4_seconds
             , a.gi_seconds
             , b.gi_goal_home
             , b.gi_goal_away
             , a.gi_bap
             , c1.t_name gm_h_t_name
             , c2.t_name gm_a_t_name
             , b.gm_date
             , b.gm_time
             , b.gm_league
             , b.gm_league as gm_league_code
             , e.league_name as gm_league_name
             , b.gm_s_code
             , d.s_name gi_s_name
             , d.s_ground gi_s_ground
             , b.gm_round
             , a.gi_tmp
             , a.gi_tap
             , a.gi_ctp
             , a.gi_sht
             , a.gi_asr
             , a.gi_gsr
             , a.gi_ssr
             , a.gi_bap
          from ff_game b
          left outer join ff_game_info a on b.gm_id  = a.gm_id
             , ff_team      c1
             , ff_team      c2
             , ff_stadium   d
             , ff_league    e
         where b.gm_id = '{$gm_id}'
           and c1.t_code = b.gm_h_t_code
           and c2.t_code = b.gm_a_t_code
           and d.s_code = b.gm_s_code
           and e.league_code = b.gm_league
        ";

    $res = sql_query($sql);
    $lst = array();
    while ($row = sql_fetch_array($res)){
        $row['gi_h_t_logo'] = G5_DATA_URL."/team/{$row['gm_h_t_code']}.png";
        $row['gi_a_t_logo'] = G5_DATA_URL."/team/{$row['gm_a_t_code']}.png";
        $lst[] = $row;
    }

    return $lst;
}

function dplay_game_info($gi_id){
  global $g5;

  $sql = "
      select a.gm_id
           , a.gi_id
           , b.gm_date
           , b.gm_time
           , b.gm_league
           , b.gm_league as gm_league_code
           , e.league_name as gm_league_name
           , b.gm_s_code
           , d.s_name gi_s_name
           , d.s_ground gi_s_ground
           , a.gi_user_id
           , a.gi_write_code
           , b.gm_h_t_code
           , b.gm_a_t_code
           , a.gi_bap
           , c1.t_name gm_h_t_name
           , c2.t_name gm_a_t_name
           , a.gi_state
           , a.gi_part
           , a.gi_formation
           , gi_h1_begin
           , gi_h2_begin
           , gi_h3_begin
           , gi_h4_begin
           , a.gi_h1_seconds
           , a.gi_h2_seconds
           , a.gi_h3_seconds
           , a.gi_h4_seconds
           , a.gi_seconds
           , b.gi_goal_home
           , b.gi_goal_away
           , b.gm_round
        from ff_game_info a
           , ff_game      b
           , ff_team      c1
           , ff_team      c2
           , ff_stadium   d
           , ff_league    e
       where b.gm_id  = a.gm_id
         and c1.t_code = b.gm_h_t_code
         and c2.t_code = b.gm_a_t_code
         and a.gi_id = '{$gi_id}'
         and d.s_code = b.gm_s_code
         and e.league_code = b.gm_league
       limit 1
      ";

  $row = sql_fetch($sql);

  if ($row){
      $row['gi_h_t_logo'] = G5_DATA_URL."/team/{$row['gm_h_t_code']}.png";
      $row['gi_a_t_logo'] = G5_DATA_URL."/team/{$row['gm_a_t_code']}.png";
  }
  return $row;
}

//------------------------------------------------
// DID-Play 경기정보 저장
//------------------------------------------------
function dplay_game_save($data)
{
    global $g5;

    if (!empty($data['gi_id']))
        $gi = dplay_game_info($data['gi_id']);

    if ($gi){
        $header = "update";
        $footer = "where gi_id = '{$data['gi_id']}'";
    }else{
        $header = "insert into";

        if (empty($data['gi_id']))
            $data['gi_id'] = str_replace("-", "", GUIDv4());
    }

    if ($data['gi_state_org'] != "END" && $data['gi_state'] == "END")
        $data['gi_seconds'] = "gi_h1_seconds + gi_h2_seconds + gi_h4_seconds + gi_h4_seconds";

    $body = "";
    if ($data['gm_id'         ]) $body .= " , gm_id         = '{$data['gm_id'          ]}' ";
    if ($data['gi_user_id'    ]) $body .= " , gi_user_id    = '{$data['gi_user_id'     ]}' ";
    if ($data['gi_write_code' ]) $body .= " , gi_write_code = '{$data['gi_write_code'  ]}' ";
    if ($data['gi_h_t_code'   ]) $body .= " , gi_h_t_code   = '{$data['gi_h_t_code'    ]}' ";
    if ($data['gi_a_t_code'   ]) $body .= " , gi_a_t_code   = '{$data['gi_a_t_code'    ]}' ";
    if ($data['gi_state'      ]) $body .= " , gi_state      = '{$data['gi_state'       ]}' ";
    if ($data['gi_part'       ]) $body .= " , gi_part       = '{$data['gi_part'        ]}' ";
    if ($data['gi_formation'  ]) $body .= " , gi_formation  = '{$data['gi_formation'   ]}' ";
    if ($data['gi_h1_begin'   ]) $body .= " , gi_h1_begin   = '{$data['gi_h1_begin'    ]}' ";
    if ($data['gi_h2_begin'   ]) $body .= " , gi_h2_begin   = '{$data['gi_h2_begin'    ]}' ";
    if ($data['gi_h3_begin'   ]) $body .= " , gi_h3_begin   = '{$data['gi_h3_begin'    ]}' ";
    if ($data['gi_h4_begin'   ]) $body .= " , gi_h4_begin   = '{$data['gi_h4_begin'    ]}' ";
    if ($data['gi_h1_seconds' ]) $body .= " , gi_h1_seconds = '{$data['gi_h1_seconds'  ]}' ";
    if ($data['gi_h2_seconds' ]) $body .= " , gi_h2_seconds = '{$data['gi_h2_seconds'  ]}' ";
    if ($data['gi_h3_seconds' ]) $body .= " , gi_h3_seconds = '{$data['gi_h3_seconds'  ]}' ";
    if ($data['gi_h4_seconds' ]) $body .= " , gi_h4_seconds = '{$data['gi_h4_seconds'  ]}' ";
    if ($data['gi_seconds'    ]) $body .= " , gi_seconds    = '{$data['gi_seconds'     ]}' ";

    $sql = " {$header} ff_game_info set gi_id = '{$data['gi_id']}' {$body} {$footer} ";

    sql_query($sql);

    // TODO state 업데이트시, ff_game 에서 기존 state 정보를 가져와서 더 나중인 정보로 갱신
    $gm = dplay_game($data['gm_id']);
    if (  ($gm['gm_state'] == "000" && $data['gi_state']!="000")
       || ($gm['gm_state'] == "H1B" && $data['gi_state']!="000" && $data['gi_state']!="H1B")
       || ($gm['gm_state'] == "H1E" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E")
       || ($gm['gm_state'] == "H2B" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B")
       || ($gm['gm_state'] == "H2E" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E")
       || ($gm['gm_state'] == "H3B" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E" && $data['gi_state']!="H3B")
       || ($gm['gm_state'] == "H3E" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E" && $data['gi_state']!="H3B" && $data['gi_state']!="H3E")
       || ($gm['gm_state'] == "H4B" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E" && $data['gi_state']!="H3B" && $data['gi_state']!="H3E" && $data['gi_state']!="H4B")
       || ($gm['gm_state'] == "H4E" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E" && $data['gi_state']!="H3B" && $data['gi_state']!="H3E" && $data['gi_state']!="H4B" && $data['gi_state']!="H4E")
     ){
       $sql = " update ff_game set gm_state = '{$data['gi_state']}' where gm_id = '{$data['gm_id']}' ";
       sql_query($sql);
     }
}

//------------------------------------------------
// DID-Play 경기 전/후반전 종료 처리
//------------------------------------------------
function dplay_game_finish_half($gi_id, $seconds)
{
    global $g5;

    $gi = dplay_game_info($gi_id);
    if (empty($gi))
        return "경기 정보를 구할 수 없습니다 : {$gi_id}";

     $MIN45 = 60 * 45;
     $MIN15 = 60 * 15;

    if ($gi['gi_state'] == "H1B"){
        $data['gi_state'] = "H1E";
        $data['gi_h1_seconds'] = ($seconds < $MIN45) ? $MIN45 : $seconds; // (int)(($timestamp*1 - $gi['gi_h1_begin']*1) / 1000);
    }
    elseif ($gi['gi_state'] == "H2B"){
        $data['gi_state'] = "H2E";
        $data['gi_h2_seconds'] = ($seconds < $MIN45) ? $MIN45 : $seconds; // (int)(($timestamp*1 - $gi['gi_h2_begin']*1) / 1000);
    }
    elseif ($gi['gi_state'] == "H3B"){
        $data['gi_state'] = "H3E";
        $data['gi_h3_seconds'] = $seconds; // (int)(($timestamp*1 - $gi['gi_h3_begin']*1) / 1000);
    }
    elseif ($gi['gi_state'] == "H4B"){
        $data['gi_state'] = "H4E";
        $data['gi_h4_seconds'] = $seconds; // (int)(($timestamp*1 - $gi['gi_h4_begin']*1) / 1000);
    }
    else return "종료 처리를 진행할 수 없는 상태입니다 : {$gi['gi_state']}";

    $body = "";
    if ($data['gi_state'     ]) $body .= " , gi_state      = '{$data['gi_state'     ]}' ";
    if ($data['gi_h1_seconds']) $body .= " , gi_h1_seconds =  {$data['gi_h1_seconds']}  ";
    if ($data['gi_h2_seconds']) $body .= " , gi_h2_seconds =  {$data['gi_h2_seconds']}  ";
    if ($data['gi_h3_seconds']) $body .= " , gi_h3_seconds =  {$data['gi_h3_seconds']}  ";
    if ($data['gi_h4_seconds']) $body .= " , gi_h4_seconds =  {$data['gi_h4_seconds']}  ";
    if ($data['gi_seconds'   ]) $body .= " , gi_seconds    =  {$data['gi_seconds'   ]}  ";

    $sql = " update ff_game_info set gi_id = '{$gi_id}' {$body} where gi_id = '{$gi_id}' ";

    sql_query($sql);

    // TODO state 업데이트시, ff_game 에서 기존 state 정보를 가져와서 더 나중인 정보로 갱신
    $gm = dplay_game($gi['gm_id']);
    if (empty($gm)) {
       return "통합 경기 정보를 구할 수 없습니다 : {$gm_id}";
    }

    if (  ($gm['gm_state'] == "000" && $data['gi_state']!="000")
       || ($gm['gm_state'] == "H1B" && $data['gi_state']!="000" && $data['gi_state']!="H1B")
       || ($gm['gm_state'] == "H1E" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E")
       || ($gm['gm_state'] == "H2B" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B")
       || ($gm['gm_state'] == "H2E" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E")
       || ($gm['gm_state'] == "H3B" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E" && $data['gi_state']!="H3B")
       || ($gm['gm_state'] == "H3E" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E" && $data['gi_state']!="H3B" && $data['gi_state']!="H3E")
       || ($gm['gm_state'] == "H4B" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E" && $data['gi_state']!="H3B" && $data['gi_state']!="H3E" && $data['gi_state']!="H4B")
       || ($gm['gm_state'] == "H4E" && $data['gi_state']!="000" && $data['gi_state']!="H1B" && $data['gi_state']!="H1E" && $data['gi_state']!="H2B" && $data['gi_state']!="H2E" && $data['gi_state']!="H3B" && $data['gi_state']!="H3E" && $data['gi_state']!="H4B" && $data['gi_state']!="H4E")
     ){
       $sql = " update ff_game set gm_state = '{$data['gi_state']}' where gm_id = '{$gi['gm_id']}' ";
       sql_query($sql);
     }
}

//------------------------------------------------
// DID-Play 경기 종료 처리
//------------------------------------------------
function dplay_game_finish($gi_id)
{
    global $g5;

    $gi = dplay_game_info($gi_id);
    if (empty($gi))
        return "경기 정보를 구할 수 없습니다 : {$gi_id}";

    // 후반종료, 연장 전/후반 종료 상태에서만 경기 종료 가능
    if ($gi['gi_state'] != "H2E" && $gi['gi_state'] != "H3E" && $gi['gi_state'] != "H4E")
        return "후반종료, 연장 전/후반 종료 상태에서만 경기 종료할 수 있습니다.";

    // 경기 종료상태 Update
    $sql = "
        update ff_game_info
           set gi_state   = 'END'
             , gi_seconds = gi_h1_seconds
                          + gi_h2_seconds
                          + gi_h3_seconds
                          + gi_h4_seconds
         where gi_id = '{$gi_id}'
        ";
    sql_query($sql);

    // 경기 종료까지 출전중인 선수들 출장시간 Update
    $sec = $gi['gi_h1_seconds']
         + $gi['gi_h2_seconds']
         + $gi['gi_h3_seconds']
         + $gi['gi_h4_seconds'];

    $sql = "
        update ff_game_player
           set gp_seconds  =  {$sec} - gp_in_seconds
         where gi_id       = '{$gi_id}'
           and gp_in_half != '00'
           and gp_out_half = '00'
        ";
    sql_query($sql);

    $sql = " update ff_game set gm_state = 'END' where gm_id = '{$gi['gm_id']}' ";
    sql_query($sql);
}

//------------------------------------------------
// DID-Play 경기 출전선수 저장
//------------------------------------------------
function dplay_game_player_save($data)
{
    global $g5;

    $sql = "
        insert into ff_game_player
           set gi_id          = '{$data['gi_id'         ]}'
             , p_id           = '{$data['p_id'          ]}'
             , gp_type        = '{$data['gp_type'       ]}'
             , gp_order       = '{$data['gp_order'      ]}'
             , gp_in_half     = '{$data['gp_in_half'    ]}'
             , gp_in_seconds  = '{$data['gp_in_seconds' ]}'
             , gp_out_half    = '{$data['gp_out_half'   ]}'
             , gp_out_seconds = '{$data['gp_out_seconds']}'
             , gp_seconds     = '{$data['gp_seconds'    ]}'
    ";

    sql_query($sql);
}

//------------------------------------------------
// DID-Play 경기 출전선수 목록
//----------------------------------------------
function dplay_game_player_list($gi_id)
{
    global $g5;

    $sql = "
        select gi.gi_id
             , gp.p_id
             , pp.p_name
             , pt.pt_num as p_number
             , power(16, pt.pt_pos-1) as p_position
             , case when gp.gp_type = 'GK' then 1
                    when gp.gp_type = 'KY' then 16
                    when gp.gp_type = 'ST' then 256
                    else 0
                end gp_type
             , gp.gp_order
             , gp.gp_in_half
             , gp.gp_in_half_seconds
             , gp.gp_in_seconds
             , gp.gp_out_half
             , gp.gp_out_half_seconds
             , gp.gp_out_seconds
             , gp.gp_seconds
          from ff_game_info   gi
          join ff_game        gm on gm.gm_id   = gi.gm_id
          join ff_game_player gp on gp.gi_id   = gi.gi_id
          join ff_player      pp on pp.p_id    = gp.p_id
          join ff_player_team pt on pt.p_id    = gp.p_id
                                and pt.t_code in (gi.gi_h_t_code, gi.gi_a_t_code)
                                and gm.gm_date between pt.pt_begin and pt.pt_end
         where gi.gi_id = '{$gi_id}'
         order by
               gp.gp_type  asc
             , gp.gp_order asc
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}

function dplay_game_player_list_20180828($gi_id)
{
    global $g5;

    $sql = "
        select a.gi_id
             , a.p_id
             , b.p_name
             , b.p_number
             , power(16, b.p_position-1) as p_position
             , case when a.gp_type = 'GK' then 1
                    when a.gp_type = 'KY' then 16
                    when a.gp_type = 'ST' then 256
                    else 0
                end gp_type
             , a.gp_order
             , a.gp_in_half
             , a.gp_in_half_seconds
             , a.gp_in_seconds
             , a.gp_out_half
             , a.gp_out_half_seconds
             , a.gp_out_seconds
             , a.gp_seconds
          from ff_game_player a
             , ff_player b
         where a.p_id = b.p_id
           and a.gi_id = '{$gi_id}'
         order by
               gp_type  asc
             , gp_order asc
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}

//------------------------------------------------
// DID-Play 선수 교체 처리
//------------------------------------------------
function dplay_game_player_change($gi_id, $p_id_fr, $p_id_to, $half, $haf_seconds, $seconds)
{
    global $g5;

    if (empty($gi_id) || empty($p_id_fr) || empty($p_id_to) || empty($half) || empty($haf_seconds) || empty($seconds))
        return "Invalid Arguments";

    $sql = "
        update ff_game_player
           set gp_out_half         = '{$half}'
             , gp_out_half_seconds =  {$haf_seconds}
             , gp_out_seconds      =  {$seconds}
             , gp_seconds          =  {$seconds} - gp_in_seconds
         where gi_id               = '{$gi_id}'
           and p_id                = '{$p_id_fr}'
           and gp_in_half         != '00'
        ";

    sql_query($sql);

    $sql = "
        update ff_game_player
           set gp_in_half          = '{$half}'
             , gp_in_half_seconds  =  {$haf_seconds}
             , gp_in_seconds       =  {$seconds}
             , gp_seconds          =  0
         where gi_id               = '{$gi_id}'
           and p_id                = '{$p_id_to}'
           and gp_in_half          = '00'
        ";

    sql_query($sql);
}

//------------------------------------------------
// DID-Play Record 정보
//------------------------------------------------
function dplay_game_record_info($gr_id)
{
    global $g5;

    $sql = "
        select gr.*
             , pp.p_name
             , pt.pt_num as p_number
             , pt.pt_pos as p_position
          from ff_game_record gr

          join ff_game_info gi
            on gi.gi_id = gr.gi_id

          join ff_game gm
            on gm.gm_id = gi.gm_id

          left outer join ff_player pp
            on pp.p_id = gr.p_id

          left outer join ff_player_team pt
            on pt.p_id = gr.p_id
           and pt.t_code = gi.gi_h_t_code
           and gm.gm_date between pt.pt_begin and pt.pt_end

         where gr.gr_id = '{$gr_id}'
        ";

    $row = sql_fetch($sql);
    return $row;
}
function dplay_game_record_info_20180828($gr_id)
{
    global $g5;

    $sql = "
        select a.*
             , b.p_name
             , b.p_number
             , b.p_position
          from ff_game_record a
          left outer join ff_player b
            on a.p_id = b.p_id
         where a.gr_id = '{$gr_id}'
        ";

    $row = sql_fetch($sql);
    return $row;
}

//------------------------------------------------
// DID-Play Record 저장
//------------------------------------------------
function dplay_game_record_save($data)
{
    global $g5;

    if (!empty($data['gr_id']))
        $gr = dplay_game_record_info($data['gr_id']);

    if ($gr){
        $header = "update";
        $footer = "where gr_id = '{$data['gr_id']}'";
    }else{
        $header = "insert into";

        // if (empty($data['gr_id']))
        //     $data['gr_id'] = str_replace("-", "", GUIDv4());
    }

    $body = "";
    if ($data['gi_id'          ]) $body .= " , gi_id           = '{$data['gi_id'          ]}' ";
    if ($data['p_id'           ]) $body .= " , p_id            = '{$data['p_id'           ]}' ";
    if ($data['t_code'         ]) $body .= " , t_code          = '{$data['t_code'         ]}' ";
    if ($data['gr_half'        ]) $body .= " , gr_half         = '{$data['gr_half'        ]}' ";
    if ($data['gr_half_seconds']) $body .= " , gr_half_seconds =  {$data['gr_half_seconds']}  ";
    if ($data['gr_seconds'     ]) $body .= " , gr_seconds      =  {$data['gr_seconds'     ]}  ";
    if ($data['gr_area_code'   ]) $body .= " , gr_area_code    = '{$data['gr_area_code'   ]}' ";
    if ($data['gr_pos_x'       ]) $body .= " , gr_pos_x        =  {$data['gr_pos_x'       ]}  ";
    if ($data['gr_pos_y'       ]) $body .= " , gr_pos_y        =  {$data['gr_pos_y'       ]}  ";
    if ($data['gr_part_pos_x'  ]) $body .= " , gr_part_pos_x   =  {$data['gr_part_pos_x'  ]}  ";
    if ($data['gr_part_pos_y'  ]) $body .= " , gr_part_pos_y   =  {$data['gr_part_pos_y'  ]}  ";
                                  $body .= " , gr_act_code     = '{$data['gr_act_code'    ]}' ";
                                  $body .= " , gr_res_code     = '{$data['gr_res_code'    ]}' ";
    if ($data['gr_regdt'       ]) $body .= " , gr_regdt        = STR_TO_DATE('{$data['gr_regdt']}', '%Y-%m-%d %H:%i:%s.%f')  ";
    if ($data['gr_res_code']!="B" && $data['gr_res_code']!="X" && $data['gr_res_code']!="H" && $data['gr_res_code']!="L" && $data['gr_res_code']!="R" && $data['gr_res_code']!="G") {
      // php 에서, 0 은 null과 동의이므로, 명시적으로 res code를 이용하여 shoot pos 를 처리해준다.
      $body .= " , gr_shoot_pos_x  = 0 , gr_shoot_pos_y  = 0";
      $body .= " , gr_shoot_rate_x  = 0.0 , gr_shoot_rate_y  = 0.0";
    } else{
      if ($data['gr_shoot_pos_x' ]) $body .= " , gr_shoot_pos_x  =  {$data['gr_shoot_pos_x' ]}  ";
      if ($data['gr_shoot_pos_y' ]) $body .= " , gr_shoot_pos_y  =  {$data['gr_shoot_pos_y' ]}  ";
      if ($data['gr_shoot_rate_x' ]) $body .= " , gr_shoot_rate_x  =  {$data['gr_shoot_rate_x' ]}  ";
      if ($data['gr_shoot_rate_y' ]) $body .= " , gr_shoot_rate_y  =  {$data['gr_shoot_rate_y' ]}  ";
    }

    $sql = " {$header} ff_game_record set gr_id = '{$data['gr_id']}' {$body} {$footer} ";

    sql_query($sql);

    // Goal 관련 항목이면 경기 및 선수별 Goal 기록 업데이트
    if ($data['gr_res_code']=="G" || $gr['gr_res_code']=="G"){
        dplay_game_reload_goal_data($data['gi_id']);
    }

    // X:Failure or B:Blocking 이면 직전 Record의 Result Code를 동일한 값으로 Update
    if (empty($data['gr_act_code']) && ($data['gr_res_code'] == "X" || $data['gr_res_code'] == "B")){

        $prev = dplay_game_record_prev($data); // 직전 Record 데이터

        if (!empty($prev_gr_id = $prev['gr_id'])){
            $sql = "
                update ff_game_record
                   set gr_res_code = '{$data['gr_res_code']}'
                 where gr_id = '{$prev_gr_id}'
                ";
            sql_query($sql);

            $prev['gr_res_code'] = $data['gr_res_code'];

            return $prev;
        }
    }
}

//------------------------------------------------
// DID-Play 직전 Record 구하기
//------------------------------------------------
function dplay_game_record_prev($data)
{
    global $g5;

    $sql = "
        select *
          from ff_game_record
         where gr_id      != '{$data['gr_id'     ]}'
           and gi_id       = '{$data['gi_id'     ]}'
           and gr_half     = '{$data['gr_half'   ]}'
           and gr_seconds <=  {$data['gr_seconds']}
         order by
               gr_seconds desc
             , gr_regdt desc
         limit 1
        ";

    return sql_fetch($sql);
    //return $row['gr_id'];
}

//------------------------------------------------
// DID-Play Record 목록
//------------------------------------------------
function dplay_game_record_list($gi_id, $gr_half)
{
    global $g5;

    $whr = empty($gr_half) ? "" : " and gr.gr_half = '{$gr_half}' ";

    $sql = "
        select gr.*
             , ifnull(gt.gt_upp     ,  0 ) gt_upp
             , ifnull(gt.gt_utp     ,  0 ) gt_utp
             , ifnull(gt.gt_ctp     ,  0 ) gt_ctp
             , ifnull(gt.gt_ttp     ,  0 ) gt_ttp
             , ifnull(gt.gt_valid   , 'N') gt_valid
             , ifnull(gt.gt_res_code,  '') gt_res_code
             , pp.p_name
             , pt.pt_num as p_number
             , pt.pt_pos as p_position
          from ff_game_record gr

          join ff_game_info gi
            on gi.gi_id = gr.gi_id

          join ff_game gm
            on gm.gm_id = gi.gm_id

          left outer join ff_game_path gt
            on gt.gt_id = gr.gt_id

          left outer join ff_player pp
            on pp.p_id = gr.p_id

          left outer join ff_player_team pt
            on pt.p_id = gr.p_id
           and pt.t_code = gi.gi_h_t_code
           and gm.gm_date between pt.pt_begin and pt.pt_end

         where gr.gi_id = '{$gi_id}' {$whr}
         order by
               gr.gr_seconds asc
            ,  gr.gr_id      asc
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}

function dplay_game_record_list_20180828($gi_id, $gr_half)
{
    global $g5;

    $whr = empty($gr_half) ? "" : " and gr_half = '{$gr_half}' ";
    $sql = "
        select a.*
             , b.p_name
             , b.p_number
             , b.p_position
          from ff_game_record a
          left outer join ff_player b
            on a.p_id = b.p_id
         where a.gi_id = '{$gi_id}'
               {$whr}
         order by
               gr_seconds asc
            ,  gr_id asc
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}

//------------------------------------------------
// DID-Play Record 삭제
//------------------------------------------------
function dplay_game_record_delete($gr_id)
{
    global $g5;

    $gr = dplay_game_record_info($gr_id);
    if (empty($gr))
        return "레코드 정보를 구할 수 없습니다.";

    // Record 삭제
    $sql = "
        delete from ff_game_record
         where gr_id = '{$gr_id}'
        ";

    sql_query($sql);

    // Goal Record인 경우에는 득점 정보 업데이트
    // if ($gr['gr_res_code'] == "G"){
    //     $gi = dplay_game_info($gr['gi_id']);
    //     if ($gi){
    //         $t = ($gi['gi_write_code']=='H') ? "home" : "away";
    //         $sql = "
    //             update ff_game
    //                set gi_goal_{$t} = gi_goal_{$t} - 1
    //              where gm_id = '{$gi['gm_id']}'
    //             ";
    //
    //         sql_query($sql);
    //     }
    // }
}

function dplay_stadium_field_upload($s_code, $s_ground) {
    if (empty($s_code) || (empty($s_ground) && $s_ground!=0)) {
      return "Invalid Arguments";
    }

    $sql = "
              update ff_stadium
              set s_ground = '{$s_ground}'
              where s_code = '{$s_code}'
           ";

    sql_query($sql);
}

//------------------------------------------------
// DID-Play Record 선수 업데이트
//------------------------------------------------
function dplay_game_record_player($grid, $pid)
{
    // 레코드 선수정보 업데이트
    $sql = "
        update ff_game_record
           set p_id  = '{$pid }'
         where gr_id = '{$grid}'
        ";

    sql_query($sql);

    // 해당 레코드가 포함된 공격루트 업데이트
    return dplay_game_path_update_by_record($grid);
}

//------------------------------------------------
// 경기 및 선수별 Goal 기록 업데이트
//------------------------------------------------
function dplay_game_reload_goal_data($gi_id) {
    // 전체 선수 Goal 수 우선 0
    $sql ="
        update ff_game_player gp
           set gp_goal =  0
         where gi_id   = '{$gi_id}'
        ";
    sql_query($sql);

    // 선수별 Goal 수 업데이트
    $tot_cnt = 0;
    $sql = "
      select p_id
           , count(*) cnt
        from ff_game_record gr
       where gr_res_code = 'G'
         and gi_id = '{$gi_id}'
       group by
             p_id
    ";

    $res = sql_query($sql);
    while ($row = sql_fetch_array($res)){
        $pid = $row['p_id'];
        $cnt = $row['cnt' ];

        if (!empty($pid)){

            $sql ="
                update ff_game_player gp
                   set gp_goal =  {$cnt  }
                 where gi_id   = '{$gi_id}'
                   and p_id    = '{$pid  }'
                ";
            sql_query($sql);
        }

        // 전체 Goal 수 계산
        $tot_cnt += $cnt;
    }

    // 경기 Goal 데이터 업데이트
    $gi = dplay_game_info($gi_id);
    $gm_id = $gi['gm_id'];
    $f = ($gi['gi_write_code']=='H') ? "home" : "away";

    $sql ="
        update ff_game
           set gi_goal_{$f} = {$tot_cnt}
         where gm_id = '{$gm_id}'
        ";
    sql_query($sql);

    return $tot_cnt;
}

//------------------------------------------------
// DID-Play Card 정보
//------------------------------------------------
function dplay_game_card_info($c_id)
{
    global $g5;

    $sql = "
        select a.*
          from ff_game_card a
         where a.c_id = '{$c_id}'
        ";

    $row = sql_fetch($sql);
    return $row;
}

//------------------------------------------------
// DID-Play Card 저장
//------------------------------------------------
function dplay_game_card_save($data)
{
    global $g5;

    if (!empty($data['c_id']))
        $gr = dplay_game_card_info($data['c_id']);

    if ($gr){
        $header = "update";
        $footer = "where c_id = '{$data['c_id']}'";
    }else{
        $header = "insert into";

        if (empty($data['c_id']))
            $data['c_id'] = str_replace("-", "", GUIDv4());
    }

     $body = "";
     if ($data['gi_id'        ]) $body .= " , gi_id         = '{$data['gi_id'         ]}' ";
     if ($data['gp_id'        ]) $body .= " , gp_id         = '{$data['gp_id'         ]}' ";
   //if ($data['gp_name'      ]) $body .= " , gp_name       = '{$data['gp_name'       ]}' ";
     if ($data['gp_card_half' ]) $body .= " , gp_card_half  = '{$data['gp_card_half'  ]}' ";
     if ($data['gp_card_time' ]) $body .= " , gp_card_time  =  {$data['gp_card_time'  ]}  ";
     if ($data['gr_seconds'   ]) $body .= " , gr_seconds    =  {$data['gr_seconds'    ]}  ";
     if ($data['gp_card_card' ]) $body .= " , gp_card_card  = '{$data['gp_card_card'  ]}' ";

    $sql = " {$header} ff_game_card set c_id = '{$data['c_id']}' {$body} {$footer} ";
    sql_query($sql);

    dplay_player_card_save($data['gi_id']);

    return $data['c_id'];
}
function dplay_game_card_save_20180828($data)
{
    global $g5;

    if (!empty($data['c_id']))
        $gr = dplay_game_card_info($data['c_id']);

    if ($gr){
        $header = "update";
        $footer = "where c_id = '{$data['c_id']}'";
    }else{
        $header = "insert into";

        if (empty($data['c_id']))
            $data['c_id'] = str_replace("-", "", GUIDv4());
    }

     $body = "";
     if ($data['gi_id'        ]) $body .= " , gi_id         = '{$data['gi_id'         ]}' ";
     if ($data['gp_id'        ]) $body .= " , gp_id         = '{$data['gp_id'         ]}' ";
     if ($data['gp_name'      ]) $body .= " , gp_name       = '{$data['gp_name'       ]}' ";
     if ($data['gp_card_half' ]) $body .= " , gp_card_half  = '{$data['gp_card_half'  ]}' ";
     if ($data['gp_card_time' ]) $body .= " , gp_card_time  =  {$data['gp_card_time'  ]}  ";
     if ($data['gr_seconds'   ]) $body .= " , gr_seconds    =  {$data['gr_seconds'    ]}  ";
     if ($data['gp_card_card' ]) $body .= " , gp_card_card  = '{$data['gp_card_card'  ]}' ";

    $sql = " {$header} ff_game_card set c_id = '{$data['c_id']}' {$body} {$footer} ";
    //$sql = "insert into ff_game_card set c_id = '{$data['c_id']}' {$body}";
    //$sql = " {$header} ff_game_card set c_id = '{$data['c_id']}' {$body} {$footer} ";

    sql_query($sql);

    return $data['c_id'];
}

//------------------------------------------------
// DID-Play Card 목록
//------------------------------------------------
function dplay_game_card_list($gi_id)
{
    global $g5;

    $sql = "
        select gc.*
             , pp.p_name as gp_name
          from ff_game_card gc

          join ff_player pp
            on pp.p_id = gc.gp_id

         where gc.gi_id = '{$gi_id}'
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}
function dplay_game_card_list_20180828($gi_id)
{
    global $g5;

    $sql = "
        select a.*
          from ff_game_card a
         where a.gi_id = '{$gi_id}'
        ";

    $res = sql_query($sql);

    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}

//------------------------------------------------
// DID-Play Card 삭제
//------------------------------------------------
function dplay_game_card_delete($c_id)
{
    global $g5;

    $gr = dplay_game_card_info($c_id);
    if (empty($gr))
        return "레코드 정보를 구할 수 없습니다.";

    $sql = "select gi_id
            from ff_game_card
            where c_id = '{$c_id}'";
    $gi_id = sql_fetch($sql)['gi_id'];

    // Record 삭제
    $sql = "
        delete from ff_game_card
         where c_id = '{$c_id}'
        ";
    sql_query($sql);
    dplay_player_card_save($gi_id);
}

function dplay_load_league_data()
{
    global $g5;

    $sql = "
        select a.*
          from ff_league a
        ";

    $lst = array();

    $res = sql_query($sql);

    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    return $lst;
}

//------------------------------------------------
// DID-Play Bap 가져오기
//------------------------------------------------
function dplay_game_bap_load($gi_id, $gr_half='')
{
    if ($gr_half)
        $whr = " and gr_half = '{$gr_half}' ";

    $sql = "
        select count(*) cnt
          from ff_game_bap
         where gi_id = '{$gi_id}' {$whr}
        ";

    $bap = sql_fetch($sql)['cnt'];

    $sql ="
        update ff_game_info
           set gi_bap = ( select count(*)
                                  from ff_game_bap
                                 where gi_id = '{$gi_id}'
                              )
         where gi_id = '{$gi_id}'
        ";

    sql_query($sql);

    return $bap;
}
function dplay_game_bap_load_old($gi_id)
{
    $sql = "
        select count(*)
          from ff_game_bap
         where gi_id = '{$gi_id}'
    ";

    $sqlres = sql_fetch($sql);

    $res = $sqlres['count(*)'];

    $gi = dplay_game_info($gi_id);

    $sql ="
        update ff_game_info
           set gi_bap = {$res}
         where gi_id = '{$gi_id}'";

    sql_query($sql);

    return $res;
}

//------------------------------------------------
// DID-Play Bap 건수만 구하기
//------------------------------------------------
function dplay_game_bap_count($gi_id, $gr_half='')
{
    if ($gr_half)
        $whr = " and gr_half = '{$gr_half}' ";

    $sql = "
        select count(*) cnt
          from ff_game_bap
         where gi_id = '{$gi_id}' {$whr}
    ";

    return sql_fetch($sql)['cnt'];
}

//------------------------------------------------
// DID-Play Bap 건수 다시 계산 (경기 전체)
// @@@@ 반드시 전/후반 따로 호출해야 함 !!!!
//------------------------------------------------
$g_bap_currR = FALSE;
$g_bap_lastR = FALSE;
$g_bap_nextR = FALSE;
$g_bap_ready = FALSE;
$g_bap_defer = FALSE;
$g_bap_count = 0;

function dplay_game_bap_reset($gi_id, $gr_half, $uplast='')
{
    global $g_bap_currR;
    global $g_bap_lastR;
    global $g_bap_nextR;
    global $g_bap_ready;
    global $g_bap_count;

    $g_bap_count = 0;

    // BAP 전체 레코드 삭제
    $whr = $gr_half ? " and gr_half = '{$gr_half}' " : "";

    $sql = "
        delete from ff_game_bap
         where gi_id = '{$gi_id}' {$whr}
        ";

    sql_fetch($sql);

    // 전체 BAP 레코드 다시 계산
    $whr = $gr_half ? " and gr.gr_half = '{$gr_half}' " : "";

    $sql = "
        select gr.*
             , gb.bap_id
          from ff_game_record gr
          left outer join
               ff_game_bap gb
            on gb.gi_id = gr.gi_id
           and gb.gr_id = gr.gr_id
         where gr.gi_id = '{$gi_id}' {$whr}
         order by
               gr.gr_seconds asc
             , gr.gr_regdt   asc
        ";

    $res = sql_query($sql);

    //
    // 1 Step Delay Looping
    //
    // >>>> DID 상에서는 ACT를 먼저 누르고 X/B 누르는 구조이기 때문에
    // >>>> DID와 동일한 기준 및 순서로 판단하기 위한 처리
    //
    while ($row = sql_fetch_array($res)){

        $g_bap_lastR = $g_bap_currR;
        $g_bap_currR = $g_bap_nextR;
        $g_bap_nextR = $row;

        if ($g_bap_currR){
            $bap = dplay_game_bap_reset_calc($g_bap_currR, $g_bap_lastR, $g_bap_nextR);
            if ($bap)
                dplay_game_bap_reset_save($bap);
        }
    }

    // 마지막 남은 레코드 강제 실행
    if ($g_bap_nextR){
        $bap = dplay_game_bap_reset_calc($g_bap_nextR, $g_bap_currR, FALSE);
        if ($bap)
            dplay_game_bap_reset_save($bap);
    }

    // READY 상태로 끝났으면 마지막 레코드 UP 처리
    if ($uplast && $g_bap_ready){
        $bap = dplay_game_bap_reset_data($g_bap_nextR, "LAST READY");
        dplay_game_bap_reset_save($bap);
    }

    // BAP 카운트 업데이트
    return dplay_game_bap_load($gi_id, $gr_half);
}

function dplay_game_bap_reset_calc($currR, $lastR, $nextR)
{
    global $g_bap_ready;
    global $g_bap_defer;

    $bap = FALSE;

    $act = $currR['gr_act_code'];
    $res = $currR['gr_res_code'];

    $area_curr = $currR['gr_area_code'];
    $area_last = $lastR ? intval($lastR['gr_area_code']) : 0;

    dplay_game_bap_reset_log("## DAT ##", "{$act}->{$currR['gr_res_code']} {$area_last}->{$area_curr} {$currR['gr_seconds']} {$currR['bap_id']}");

    // DID 상에서는 ACT를 먼저 누르고 X/B 누르는 구조이기 때문에
    // DID와 동일한 기준 및 순서로 판단하기 위한 처리
    if (!empty($act)){
        if ($act=="S" || $act=="H" || $act=="R"){
            if ($nextR && empty($nextR['gr_act_code'])){
                $res = "O";
            }
        }else $res = "O";
    }

    // Ready 상태에서
    if ($g_bap_ready)
    {
        // 이전 레코드와 4초 이상 벌어졌으면 UP
        if ($lastR && intval($currR['gr_seconds']) - intval($lastR['gr_seconds']) > 4){
            $bap = dplay_game_bap_reset_data($currR, "4 SECONDS");
        }

        // 진행이 마무리 되었으면 UP
        elseif (!empty($res) && $res != "O"){
            $bap = dplay_game_bap_reset_data($currR, "DONE");
        }

        // 공격영역(1~6)으로 진입했으면 UP
        elseif ($area_curr < 7){
            $bap = dplay_game_bap_reset_data($currR, "ATTACK");
        }

        // Ready 상태 나머지는 경우는 SKIP
    }
    // Ready 상태가 아닌 경우
    else
    {
        // 경기 시작(전/후반) 직후 바로 공격 진영으로 진입한 경우이면 Ready
        if ($lastR === FALSE && $area_curr < 10){
            $g_bap_ready = TRUE;
            dplay_game_bap_reset_log("*********", "READY : BEGIN");
        }
        // 후방에서 슈팅한 경우이면 Ready
        // 슈팅의 경우는 Act 및 Res 발생 시 중복 저장이 이루어지므로 Act 발생시에만 Ready 해주면 결과 발생 시 UP 된다
        elseif($area_curr > 9 && ($act=="S" || $act=="H" || $act=="R")){
            // 슈팅이 바로 마무리 되었으면 UP
            if (!empty($res) && $res!="O"){
                $bap = dplay_game_bap_reset_data($currR, "SHOOT");
            }
            // 슈팅 다음 ACT로 이어지는 경우이면 READY
            else{
                $g_bap_ready = TRUE;
                dplay_game_bap_reset_log("*********", "READY : SHOOT");
            }
        }
        // 중앙선을 넘어왔으면
        elseif ($area_last > 9 && $area_curr < 10){

            // X로 중앙선 넘은건 Ready 보류
            if (empty($act) && $res=="X"){
                $g_bap_defer = true;
                dplay_game_bap_reset_log("*********", "KEEP");
            }
            // X 이외로 넘어온건 인정
            else{
                // B로 바로 마무리 되었으면 UP
                if (empty($act) && $res=="B"){
                    $bap = dplay_game_bap_reset_data($currR, "CROSS B");
                }
                // 공격 영역으로 들어왔으면 UP
                elseif ($area_curr < 7){
                    $bap = dplay_game_bap_reset_data($currR, "CROSS ATTACK");
                }
                // 중앙선만 넘어온 경우이면 Ready
                else{
                    $g_bap_ready = TRUE;
                    dplay_game_bap_reset_log("*********", "READY");
                }
            }
        }
        // Ready 보류 상태에서 바로 전방 포인트가 발생하면 Ready or UP
        else if ($g_bap_defer && $area_curr < 10){
            // 공격 영역이면 바로 UP
            if ($area_curr < 7){
                $bap = dplay_game_bap_reset_data($currR, "KEEP");
            }
            // 나머지 전방 영역은 경우이면 Ready
            else{
                dplay_game_bap_reset_log("*********", "READY : KEEP");
                $g_bap_ready = true;
            }
        }
    }

    if ($bap) {
        $g_bap_ready = FALSE;
        $g_bap_defer = FALSE;
    }
    else if ($g_bap_ready){
        $g_bap_defer = FALSE;
    }

    return $bap;
}

function dplay_game_bap_reset_log($tag, $msg)
{
    return; // Do Nothing

    echo "<pre style='display:block;margin:0;padding:0;'>";
    echo "{$tag} {$msg}";
    echo "</pre>".PHP_EOL;
}

function dplay_game_bap_reset_data($row, $desc)
{
    $bap = array();

    $bap['bap_id'         ] = uniqid('', TRUE);
    $bap['gi_id'          ] = $row['gi_id'          ];
    $bap['gr_id'          ] = $row['gr_id'          ];
    $bap['t_code'         ] = $row['t_code'         ];
    $bap['gr_half'        ] = $row['gr_half'        ];
    $bap['gr_half_seconds'] = $row['gr_half_seconds'];
    $bap['gr_seconds'     ] = $row['gr_seconds'     ];
    $bap['gr_regdt'       ] = $row['gr_regdt'       ];
    $bap['desc'           ] = $desc;

    return $bap;
}

function dplay_game_bap_reset_save($bap)
{
    global $g_bap_count;

    ++$g_bap_count;

    dplay_game_bap_reset_log(">>>>>>>>>", "UP : {$bap['desc']} : {$g_bap_count}");

    $sql = "
        insert into ff_game_bap
           set bap_id          = '{$bap['bap_id'         ]}'
             , gi_id           = '{$bap['gi_id'          ]}'
             , gr_id           = '{$bap['gr_id'          ]}'
             , t_code          = '{$bap['t_code'         ]}'
             , gr_half         = '{$bap['gr_half'        ]}'
             , gr_half_seconds = '{$bap['gr_half_seconds']}'
             , gr_seconds      = '{$bap['gr_seconds'     ]}'
             , gr_regdt        = '{$bap['gr_regdt'       ]}'
        ";

    sql_fetch($sql);
}

//------------------------------------------------
// DID-Play Bap 삽입
//------------------------------------------------
function dplay_game_bap_save($data)
{
    global $g5;

    $header = "insert into";
    $body = "";

    if ($data['gi_id'          ]) $body .= " , gi_id           = '{$data['gi_id'          ]}' ";
    if ($data['gr_id'          ]) $body .= " , gr_id           = '{$data['gr_id'          ]}' ";
    if ($data['t_code'         ]) $body .= " , t_code          = '{$data['t_code'         ]}' ";
    if ($data['gr_half'        ]) $body .= " , gr_half         = '{$data['gr_half'        ]}' ";
    if ($data['gr_half_seconds']) $body .= " , gr_half_seconds =  {$data['gr_half_seconds']}  ";
    if ($data['gr_seconds'     ]) $body .= " , gr_seconds      =  {$data['gr_seconds'     ]}  ";
    if ($data['gr_regdt'       ]) $body .= " , gr_regdt        = STR_TO_DATE('{$data['gr_regdt']}', '%Y-%m-%d %H:%i:%s.%f')  ";

    $sql = " {$header} ff_game_bap set bap_id = '{$data['bap_id']}' {$body}";

    sql_query($sql);

    try
    {
        return dplay_game_bap_load($data['gi_id'], $data['gr_half']);
    }
    catch(Exception $e)
    {
        return "0";
    }
}

//------------------------------------------------
// DID-Play 공격루트 재계산(경기 전체 다시 계산)
//------------------------------------------------
$g_path_currR = FALSE;
$g_path_lastR = FALSE;
$g_path_nextR = FALSE;
$g_path_mking = FALSE;
$g_path_valid = FALSE;
$g_path_ptype = FALSE;
$g_path_array = array();
$g_path_newer = array();

function dplay_game_path_reset($gi_id, $gr_half)
{
//    echo "<pre style='display:block;margin:0;padding:0;'>";

    global $g_path_currR;
    global $g_path_lastR;
    global $g_path_nextR;
    global $g_path_mking;
    global $g_path_valid;
    global $g_path_array;
    global $g_path_newer;

    $g_path_mking = FALSE;
    $g_path_valid = FALSE;
    $g_path_array = array();
    $g_path_newer = array();

    // 전체 레코드 다시 계산
    $sql = "
        select gr.*
             , gt.gt_valid
          from ff_game_record gr
          left outer join ff_game_path gt
            on gt.gt_id   = gr.gt_id
         where gr.gi_id   = '{$gi_id  }'
           and gr.gr_half = '{$gr_half}'
         order by
               gr.gr_seconds asc
             , gr.gr_regdt   asc
        ";

    $res = sql_query($sql);

    // Path 레코드 초기화를 위해 먼저 메모리에 담아둔다.
    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst[] = $row;
    }

    // 해당 경기 전체 PATH 레코드 삭제 (Half 기준)
    // $$$$ 왠지 모르게 쓰레기 데이터가 쌓인다.
    // $$$$ 아래와 같이 쓰레기 데이터도 함께 삭제해주어야 전체 건수가 이상이 없다.
    $sql = "
        delete 
          from ff_game_path
         where gt_id in (SELECT gt_id 
                           FROM (
                                 SELECT gt_id
                                   from ff_game_path
	                              where gi_id = '{$gi_id}'
	                                and gt_id not in (select distinct gt_id
	                                                    from ff_game_record gr
	                                                   where gr.gi_id    = '{$gi_id  }'
	                                                     and gr.gr_half != '{$gr_half}'
	                                                 )
	                            ) mm
                        )
        ";

    sql_query($sql);

    //
    // 1 Step Delay Looping
    //
    // >>>> DID 상에서는 ACT를 먼저 누르고 X/B 누르는 구조이기 때문에
    // >>>> DID와 동일한 기준 및 순서로 판단하기 위한 처리
    //
    foreach ($lst as $row){

        $g_path_lastR = $g_path_currR;
        $g_path_currR = $g_path_nextR;
        $g_path_nextR = $row;

        if ($g_path_currR){
            $bap = dplay_game_path_reset_calc($g_path_currR, $g_path_lastR, $g_path_nextR);
        }
    }

    // 마지막 남은 레코드 강제 실행
    if ($g_path_nextR){
        $bap = dplay_game_path_reset_calc($g_path_nextR, $g_path_currR, FALSE);
    }

    // 미처리된 공격루트 저장 처리
    dplay_game_path_reset_done("WREST");

    // 경기평점 다시 계산(팀,선수 전체)
    dplay_game_rating_update_by_game($gi_id);

//    echo "</pre>".PHP_EOL;

    // 업데이트된 내용이 있는 레코드 반환
    return $g_path_newer;
}

function dplay_game_path_reset_calc($currR, $lastR, $nextR)
{
    global $g_path_mking;
    global $g_path_valid;
    global $g_path_array;
    global $g_path_ptype;

    $act = $currR['gr_act_code'];
    $res = $currR['gr_res_code'];

    $area_curr = $currR['gr_area_code'];
    $area_last = $lastR ? intval($lastR['gr_area_code']) : 0;

    // DID 상에서는 ACT를 먼저 누르고 X/B 누르는 구조이기 때문에
    // DID와 동일한 기준 및 순서로 판단하기 위한 처리
    if (!empty($act)){
        if ($act=="S" || $act=="H" || $act=="R"){
            if ($nextR && empty($nextR['gr_act_code'])){
                $res = "O";
            }
        }else $res = "O";
    }

    // 이전 레코드와 4초 이상 벌어졌으면 완료 (이전 루트까지만 적용)
    if ($g_path_mking && $lastR && (intval($currR['gr_seconds']) - intval($lastR['gr_seconds']) > 4)) {
        // 완료처리
        dplay_game_path_reset_done("4 Seconds");
        // 현재 레코드까지는 완료처리 후 새루운 루트에 분리시킨다. (재귀호출)
        dplay_game_path_reset_calc($currR, $lastR, $nextR);
        return TRUE;
    }

    // Log
    dplay_game_path_reset_log("## DATA ##", ($act ? $act : " ")."->{$currR['gr_res_code']} "
        .str_pad($area_last, 2, " ", STR_PAD_LEFT)."->"
        .str_pad($area_curr, 2, " ", STR_PAD_LEFT)." "
        .str_pad($currR['gr_seconds'], 7, " ", STR_PAD_LEFT)
        ." {$currR['gr_path_valid']} / {$currR['gr_path_id']}"
        );

    // 진행중 표시
    $making = $g_path_mking;
    if(!$g_path_mking) {
        $g_path_mking = TRUE;
        if ($area_curr > 6){
            $g_path_ptype = "UPP";
            dplay_game_path_reset_log(">>>>>>>>>>", $g_path_ptype);
        }else{
            dplay_game_path_reset_log(">>>>>>>>>>", "MAKING");
        }
    }

    // 루트에 슈팅이 있으면 전/후방 무관하게 유효 표시
    if (!empty($act) && ($act=="S" || $act=="H" || $act=="R")) {
        $g_path_valid = true;
        $g_path_ptype = "CTP";
        dplay_game_path_reset_log(">>>>>>>>>>", $g_path_ptype);
    }
    // 공격영역(1~6)으로 진입했으면 유효 표시
    elseif ($area_curr < 7) {
        $g_path_valid = true;
        // 이미 CTP로 판정된 공격루트가 아닌 경우에만 UTP 표시
        if ($g_path_ptype!="CTP"){
            $g_path_ptype = "UTP";
            dplay_game_path_reset_log(">>>>>>>>>>", $g_path_ptype);
        }
    }

    // 공격루트 추가
    array_push($g_path_array, $currR);

    // 진행이 마무리 되었으면 완료
    if (!empty($res) && $res != "O"){
        dplay_game_path_reset_done("Res = {$res}");
        return TRUE;
    }

    // 나머지는 미완료
    return FALSE;
}

function dplay_game_path_reset_log($tag, $msg)
{
//    echo (($tag=="## DATA ##") ? PHP_EOL:' ')."{$tag} {$msg}";
}

function dplay_game_path_reset_done($desc)
{
    global $g_path_mking;
    global $g_path_valid;
    global $g_path_array;
    global $g_path_newer;
    global $g_path_ptype;

    if (count($g_path_array) > 0){

        dplay_game_path_reset_log("**********", "DONE : {$desc} ptype={$g_path_ptype}");

        // 공격루트 정보
        reset($g_path_array);

        $gt_info = array();
        $gt_info['gt_id'      ] = uniqid('',TRUE);
        $gt_info['gi_id'      ] = current($g_path_array)['gi_id'];
        $gt_info['gt_valid'   ] = ($path_valid = $g_path_valid ? "Y" : "N");

        // 공격 레코드별 업데이트
        $gr_list = array();

        reset($g_path_array);
        foreach ($g_path_array as $row){

            // 업데이트 대상에 추가
            $row['gt_id'] = $gt_info['gt_id'];
            array_push($gr_list, $row);

            // 원본 대비 변경된 내용이 있으면 호출한 쪽으로 되돌려줘서
            // UI 업데이트 가능하도록 해야한다.
            if ($row['gt_valid'] != $path_valid){
                array_push($g_path_newer, array("gr_id"=>$row['gr_id'], "gt_valid"=>$path_valid));
            }
        }

        // 공격루트 저장
        dplay_game_path_update($gt_info, $gr_list, FALSE);
    }

    // 초기화
    $g_path_mking = FALSE;
    $g_path_valid = FALSE;
    $g_path_ptype = FALSE;
    $g_path_array = array();
}

//------------------------------------------------
// DID-Play 공격루트 업데이트 (레코드 기반)
//------------------------------------------------
function dplay_game_path_update_by_record($grid)
{
    $sql = "
        select *
          from ff_game_record
         where gr_id = '{$grid}'
        ";

    $gtid = sql_fetch($sql)['gt_id'];

    return dplay_game_path_update_by_id($gtid);
}

function dplay_game_path_update_by_id($gtid)
{
    // 공격루트 정보
    $sql = "
        select *
          from ff_game_path
         where gt_id = '{$gtid}'
        ";

    $gtinfo = sql_fetch($sql);

    // 레코드 목록
    $sql = "
        select *
          from ff_game_record
         where gt_id = '{$gtid}'
         order by
               gr_seconds asc
             , gr_regdt   asc
        ";

    $res = sql_query($sql);

    $grlist = array();
    while ($row = sql_fetch_array($res)){
        $grlist[] = $row;
    }

    // 공격루트 업데이트
    return dplay_game_path_update($gtinfo, $grlist);
}

//------------------------------------------------
// DID-Play 공격루트 업데이트
//------------------------------------------------
function dplay_game_path_update($gtinfo, $grlist, $rating=TRUE)
{
    $ret = array();
    $ret['result' ] = TRUE;
    $ret['message'] = "";

    if (!$gtinfo || !is_array($grlist) || count($grlist) < 1){
        $ret['result' ] = FALSE;
        $ret['message'] = "Invalid Arguments";
        return $ret;
    }

    // 공격루트 정보 산출
    $ptype = "UPP";
    $gtype = "NAN";
    $count = 0;

    foreach($grlist as $item){

        $act = $item['gr_act_code'];
        $res = $item['gr_res_code'];
        $ara = intval($item['gr_area_code']);
        
        // 실제 공격 카운트 (단순 X/B 제외)
        if (!empty($act))
            ++$count;

        // 슈팅이 있으면 전/후방 무관하게 CTP
        if (!empty($act) && ($act=="S" || $act=="H" || $act=="R")) {
            $ptype = "CTP";
            if ($res=="G"){
                $gtype = "GOL";
            }
        }
        // 공격영역(1~6)으로 진입했으면 유효 표시
        elseif ($ara < 7) {
            // 이미 CTP로 판정된 공격루트가 아닌 경우에만 UTP 표시
            if ($ptype!= "CTP"){
                $ptype = "UTP";
            }
        }
    }
    
    // 단독슛인 경우 별도 처리
    if ($ptype== "CTP" && $count < 2){
        $ptype = "STP";
    }

    $gtinfo['gt_upp'     ] = ($ptype == "UPP") ? "1" : "0";
    $gtinfo['gt_utp'     ] = ($ptype == "UTP") ? "1" : "0";
    $gtinfo['gt_ctp'     ] = ($ptype == "CTP") ? "1" : "0";
    $gtinfo['gt_stp'     ] = ($ptype == "STP") ? "1" : "0";
    $gtinfo['gt_ttp'     ] = ($ptype == "UTP" || $ptype == "CTP") ? "1" : "0";
    $gtinfo['gt_valid'   ] = ($ptype == "UTP" || $ptype == "CTP") ? "Y" : "N";
    $gtinfo['gt_res_code'] = end($grlist)['gr_res_code'];

    // 공격루트 Insert or Update
    $set = "
               gt_id       = '{$gtinfo['gt_id'      ]}'
             , gi_id       = '{$gtinfo['gi_id'      ]}'
             , gt_upp      = '{$gtinfo['gt_upp'     ]}'
             , gt_utp      = '{$gtinfo['gt_utp'     ]}'
             , gt_ctp      = '{$gtinfo['gt_ctp'     ]}'
             , gt_stp      = '{$gtinfo['gt_stp'     ]}'
             , gt_ttp      = '{$gtinfo['gt_ttp'     ]}'
             , gt_valid    = '{$gtinfo['gt_valid'   ]}'
             , gt_res_code = '{$gtinfo['gt_res_code']}'
        ";

    $sql = "
        insert into ff_game_path
           set {$set}
            on duplicate key
        update {$set}
        ";

    sql_query($sql);

    // CTP의 경우에는 AST,CTB,CTM,CTA,CTS,GTB,GTM 산출
    if ($ptype == "CTP"){

        $pid_s = FALSE;
        $pid_a = FALSE;
        $pid_m = FALSE;
        $pid_b = FALSE;

        for ($i = count($grlist) - 1; $i >= 0; $i--){

            $item = $grlist[$i];

            $item['gr_is_ast'  ] = 0;
            $item['gr_is_ctb'  ] = 0;
            $item['gr_is_ctm'  ] = 0;
            $item['gr_is_cta'  ] = 0;
            $item['gr_is_cts'  ] = 0;
            $item['gr_is_gtb'  ] = 0;
            $item['gr_is_gtm'  ] = 0;

            $act = $item['gr_act_code'];
            $res = $item['gr_res_code'];
            
            // Shoot
            if (!$pid_s && ($act=="S" || $act=="H" || $act=="R")){
                if (empty($item['p_id']))
                    break;
                $pid_s = $item['p_id'];
                $item['gr_is_cts'] = "1";
            }
            // Assist
            elseif (!$pid_a && $pid_s && $pid_s != $item['p_id']){
                if (empty($item['p_id']))
                    break;
                $pid_a = $item['p_id'];
                $item['gr_is_cta'] = "1";
                $item['gr_is_ast'] = ($gtype == "GOL") ? "1":"0";
            }
            // Maker
            elseif (!$pid_m && $pid_a && $pid_a != $item['p_id']){
                if (empty($item['p_id']))
                    break;
                $pid_m = $item['p_id'];
                $item['gr_is_ctm'] = "1";
                $item['gr_is_gtm'] = ($gtype == "GOL") ? "1":"0";
            }
            // Builder
            elseif ($pid_m && $pid_b != $item['p_id']){
                $pid_b = $item['p_id'];
                $item['gr_is_ctb'] = "1";
                $item['gr_is_gtb'] = ($gtype == "GOL") ? "1":"0";
            }

            $grlist[$i] = $item;
        }
    }

    // 레코드 목록 업데이트
    if (is_array($grlist)){
        reset($grlist);
        foreach($grlist as $item){

            $act = $item['gr_act_code'];
            $res = $item['gr_res_code'];
            $ara = intval($item['gr_area_code']);

            $item['gr_is_tmp'  ] =   $act ? "1":"0";
            $item['gr_is_tmp_s'] = ( $res=="O" || $res=="G") ? "1":"0";
            $item['gr_is_tap'  ] = ( $gtinfo['gt_valid']=="Y" && $act) ? "1":"0";
            $item['gr_is_tap_s'] = ( $gtinfo['gt_valid']=="Y" &&
                                    ($res=="O" || $res=="G")) ? "1":"0";
            $item['gr_is_sht'  ] = ( $act=="S" || $act=="H" || $act=="R" ) ? "1":"0";
            $item['gr_is_sht_s'] = (($act=="S" || $act=="H" || $act=="R" ) &&
                                    ($res=="G" || $res=="R" || $res=="L" || $res=="H" || (
                                     $res=="B" && ($item['gr_shoot_pos_x'] > 0 || $item['gr_shoot_pos_y'] > 0))
                                    )
                                   ) ? "1":"0";
            $item['gr_is_gol'  ] = ($res=="G") ? "1":"0";

            $sql = "
                update ff_game_record
                   set gt_id       = '{$item['gt_id'      ]}'
                     , gr_is_tmp   = '{$item['gr_is_tmp'  ]}'
                     , gr_is_tmp_s = '{$item['gr_is_tmp_s']}'
                     , gr_is_tap   = '{$item['gr_is_tap'  ]}'
                     , gr_is_tap_s = '{$item['gr_is_tap_s']}'
                     , gr_is_ast   = '{$item['gr_is_ast'  ]}'
                     , gr_is_sht   = '{$item['gr_is_sht'  ]}'
                     , gr_is_sht_s = '{$item['gr_is_sht_s']}'
                     , gr_is_gol   = '{$item['gr_is_gol'  ]}'
                     , gr_is_ctb   = '{$item['gr_is_ctb'  ]}'
                     , gr_is_ctm   = '{$item['gr_is_ctm'  ]}'
                     , gr_is_cta   = '{$item['gr_is_cta'  ]}'
                     , gr_is_cts   = '{$item['gr_is_cts'  ]}'
                     , gr_is_gtb   = '{$item['gr_is_gtb'  ]}'
                     , gr_is_gtm   = '{$item['gr_is_gtm'  ]}'
                 where gr_id       = '{$item['gr_id'      ]}'
                ";

            sql_query($sql);
        }
    }

    // 경기평점 업데이트 (팀,선수 전체)
    if ($rating)
        return dplay_game_rating_update_by_path($gtinfo['gi_id'], $gtinfo['gt_id']);
    else
        return $ret;
}

//------------------------------------------------
// DID-Play 경기평점 업데이트 (팀 및 선수)
//------------------------------------------------
function dplay_game_rating_update_by_game($giid)
{
    // 팀평점 업데이트
    $ret = dplay_game_rating_team_update($giid);
    if (!$ret['result'])
        return $ret;

    // 선수평점 업데이트
    return dplay_game_rating_player_update_by_game($giid, $ret['output']);
}

function dplay_game_rating_update_by_path($giid, $gtid)
{
    // 팀평점 업데이트
    $ret = dplay_game_rating_team_update($giid);
    if (!$ret['result'])
        return $ret;

    // 선수평점 업데이트
    return dplay_game_rating_player_update_by_path($gtid, $ret['output']);
}

//------------------------------------------------
// DID-Play 팀평점 업데이트
//------------------------------------------------
function dplay_game_rating_team_update($giid)
{
    $ret = array();
    $ret['result' ] = TRUE;
    $ret['message'] = "";

    // 공격루트 기반 산출
    $sql = "
        select sum(gt_utp) gi_utp
             , sum(gt_ctp) gi_ctp
             , sum(gt_stp) gi_stp
             , sum(gt_ttp) gi_ttp
             , sum(gt_ctp) gi_ttp_sc
          from ff_game_path
         where gi_id = '{$giid}'
        ";

    $gt = sql_fetch($sql);

    // 레코드 기반 산출
    $sql = "
        select sum(gr_is_tmp  ) gi_tmp
             , sum(gr_is_tmp_s) gi_tmp_sc
             , sum(gr_is_tap  ) gi_tap
             , sum(gr_is_tap_s) gi_tap_sc
             , sum(gr_is_sht  ) gi_sht
             , sum(gr_is_gol  ) gi_gol
             , sum(gr_is_ctb  ) gi_ctb
             , sum(gr_is_ctm  ) gi_ctm
             , sum(gr_is_cta  ) gi_cta
             , sum(gr_is_cts  ) gi_cts
             , sum(gr_is_gtb  ) gi_gtb
             , sum(gr_is_gtm  ) gi_gtm
          from ff_game_record
         where gi_id = '{$giid}'
        ";

    $gi = sql_fetch($sql);

    // BAP 카운트
    $sql = "
        select count(*) gi_bap
          from ff_game_bap
         where gi_id = '{$giid}'
        ";

    $bp = sql_fetch($sql);

    // 취합 및 평점산출
    $res = array();

    $res['gi_tmp'   ] = floatval($gi['gi_tmp'   ]);
    $res['gi_tmp_sc'] = floatval($gi['gi_tmp_sc']);
    $res['gi_tap'   ] = floatval($gi['gi_tap'   ]);
    $res['gi_tap_sc'] = floatval($gi['gi_tap_sc']);
    $res['gi_utp'   ] = floatval($gt['gi_utp'   ]);
    $res['gi_ctp'   ] = floatval($gt['gi_ctp'   ]);
    $res['gi_stp'   ] = floatval($gt['gi_stp'   ]);
    $res['gi_ttp'   ] = floatval($gt['gi_ttp'   ]);
    $res['gi_ttp_sc'] = floatval($gt['gi_ttp_sc']);
    $res['gi_sht'   ] = floatval($gi['gi_sht'   ]);
    $res['gi_gol'   ] = floatval($gi['gi_gol'   ]);
    $res['gi_ctb'   ] = floatval($gi['gi_ctb'   ]);
    $res['gi_ctm'   ] = floatval($gi['gi_ctm'   ]);
    $res['gi_cta'   ] = floatval($gi['gi_cta'   ]);
    $res['gi_cts'   ] = floatval($gi['gi_cts'   ]);
    $res['gi_gtb'   ] = floatval($gi['gi_gtb'   ]);
    $res['gi_gtm'   ] = floatval($gi['gi_gtm'   ]);
    $res['gi_bap'   ] = floatval($bp['gi_bap'   ]);

    $res['gi_tmp_sr'] = ($res['gi_tmp'] == 0) ? 0 : ($res['gi_tmp_sc'] / $res['gi_tmp']);
    $res['gi_tap_sr'] = ($res['gi_tap'] == 0) ? 0 : ($res['gi_tap_sc'] / $res['gi_tap']);
    $res['gi_ttp_sr'] = ($res['gi_ttp'] == 0) ? 0 : ($res['gi_ttp_sc'] / $res['gi_ttp']);
    $res['gi_ttp_pr'] = ($res['gi_tap'] == 0) ? 0 : ($res['gi_ttp'   ] / $res['gi_tap']);
    $res['gi_gsr'   ] = ($res['gi_tap'] == 0) ? 0 : ($res['gi_gol'   ] / $res['gi_tap']); // GSR = GOAL / TAP
    $res['gi_ssr'   ] = ($res['gi_sht'] == 0) ? 0 : ($res['gi_gol'   ] / $res['gi_sht']); // SSR = GOL / SHT * 100
    $res['gi_asr'   ] = ($res['gi_tap'] == 0) ? 0 : ($res['gi_tap_sc'] / $res['gi_tap']); // ASR (공격 성공률) = (1 - ((TAP-TAP_SC)/TAP)) * 100

    // 기준값
    $CONST_BAS_TAP = (float)((_DATA_VERSION_=='BIGDB') ? 200 : 300);
    $CONST_BAS_CTP = (float)((_DATA_VERSION_=='BIGDB') ?  15 :  20);
    $CONST_BAS_BAP = (float)  80;
    $CONST_BAS_ASR = (float) 0.8;
    $CONST_BAS_SHT = (float)  20;
    $CONST_BAS_GOL = (float)  30;
    $CONST_BAS_GSR = (float)0.02;
    $CONST_BAS_SSR = (float) 0.2;

    // 가중치
    $CONST_RAT_TAP = (float)15;
    $CONST_RAT_CTP = (float)20;
    $CONST_RAT_BAP = (float)15;
    $CONST_RAT_ASR = (float) 5;
    $CONST_RAT_SHT = (float)10;
    $CONST_RAT_GOL = (float)20;
    $CONST_RAT_GSR = (float)10;
    $CONST_RAT_SSR = (float) 5;

    // 평점
    $rat = array();
    $rat['tap'] = ($res['gi_tap'] / $CONST_BAS_TAP * 100) / 100 * $CONST_RAT_TAP;
    $rat['ctp'] = ($res['gi_ctp'] / $CONST_BAS_CTP * 100) / 100 * $CONST_RAT_CTP;
    $rat['bap'] = ($res['gi_bap'] / $CONST_BAS_BAP * 100) / 100 * $CONST_RAT_BAP;
    $rat['asr'] = ($res['gi_asr'] / $CONST_BAS_ASR * 100) / 100 * $CONST_RAT_ASR;
    $rat['sht'] = ($res['gi_sht'] / $CONST_BAS_SHT * 100) / 100 * $CONST_RAT_SHT;
    $rat['gol'] = ($res['gi_gol'] / $CONST_BAS_GOL * 100) / 100 * $CONST_RAT_GOL;
    $rat['gsr'] = ($res['gi_gsr'] / $CONST_BAS_GSR * 100) / 100 * $CONST_RAT_GSR;
    $rat['ssr'] = ($res['gi_ssr'] / $CONST_BAS_SSR * 100) / 100 * $CONST_RAT_SSR;

    $sum = $rat['tap']
         + $rat['ctp']
         + $rat['bap']
         + $rat['asr']
         + $rat['sht']
         + $rat['gol']
         + $rat['gsr']
         + $rat['ssr'];

    $res['gi_score' ] = ($sum / 2) + 45;

    // Update
    $sql = "
        update ff_game_info
           set gi_tmp    = '{$res['gi_tmp'   ]}'
             , gi_tmp_sc = '{$res['gi_tmp_sc']}'
             , gi_tmp_sr = '{$res['gi_tmp_sr']}'
             , gi_tap    = '{$res['gi_tap'   ]}'
             , gi_tap_sc = '{$res['gi_tap_sc']}'
             , gi_tap_sr = '{$res['gi_tap_sr']}'
             , gi_utp    = '{$res['gi_utp'   ]}'
             , gi_ctp    = '{$res['gi_ctp'   ]}'
             , gi_stp    = '{$res['gi_stp'   ]}'
             , gi_ttp    = '{$res['gi_ttp'   ]}'
             , gi_ttp_sc = '{$res['gi_ttp_sc']}'
             , gi_ttp_sr = '{$res['gi_ttp_sr']}'
             , gi_ttp_pr = '{$res['gi_ttp_pr']}'
             , gi_sht    = '{$res['gi_sht'   ]}'
             , gi_gol    = '{$res['gi_gol'   ]}'
             , gi_ctb    = '{$res['gi_ctb'   ]}'
             , gi_ctm    = '{$res['gi_ctm'   ]}'
             , gi_cta    = '{$res['gi_cta'   ]}'
             , gi_cts    = '{$res['gi_cts'   ]}'
             , gi_gtb    = '{$res['gi_gtb'   ]}'
             , gi_gtm    = '{$res['gi_gtm'   ]}'
             , gi_asr    = '{$res['gi_asr'   ]}'
             , gi_gsr    = '{$res['gi_gsr'   ]}'
             , gi_ssr    = '{$res['gi_ssr'   ]}'
             , gi_score  = '{$res['gi_score' ]}'
         where gi_id = '{$giid}'
        ";

    sql_query($sql);

    $ret['output'] = $res;
    return $ret;
}

//------------------------------------------------
// DID-Play 선수평점 업데이트
//------------------------------------------------
function dplay_game_rating_player_update_by_game($giid, $tinf)
{
    $ret = array();
    $ret['result' ] = TRUE;
    $ret['message'] = "";

    $sql = "
        select *
          from ff_game_player
         where gi_id = '{$giid}'
           and gp_in_half != '00'
        ";

    $res = sql_query($sql);

    while ($row = sql_fetch_array($res)){

        $ret = dplay_game_rating_player_update($row['gi_id'], $row['p_id'], $tinf);
        if (!$ret['result'])
            return $ret;
    }

    return $ret;
}

function dplay_game_rating_player_update_by_path($gtid, $tinf)
{
    $ret = array();
    $ret['result' ] = TRUE;
    $ret['message'] = "";

    $sql = "
        select *
          from ff_game_record
         where gt_id = '{$gtid}'
           and p_id is not null
           and p_id != ''
        ";

    $res = sql_query($sql);

    while ($row = sql_fetch_array($res)){

        $ret = dplay_game_rating_player_update($row['gi_id'], $row['p_id'], $tinf);
        if (!$ret['result'])
            return $ret;

    }

    return $ret;
}

function dplay_game_rating_player_update($giid, $pid, $tinf)
{
    $ret = array();
    $ret['result' ] = TRUE;
    $ret['message'] = "";

    // 기본값 산출
    $sql = "
        select sum(gr_is_tmp  ) tmp
             , sum(gr_is_tmp_s) tmp_s
             , sum(gr_is_tap  ) tap
             , sum(gr_is_tap_s) tap_s
             , sum(gr_is_sht  ) sht
             , sum(gr_is_sht_s) sht_s
             , sum(gr_is_ctb  ) ctb
             , sum(gr_is_ctm  ) ctm
             , sum(gr_is_cta  ) cta
             , sum(gr_is_cts  ) cts
             , sum(gr_is_gtm  ) gtm
             , sum(gr_is_gtb  ) gtb
             , sum(gr_is_ast  ) ast
             , sum(gr_is_gol  ) gol
          from ff_game_record
         where gi_id = '{$giid}'
           and p_id  = '{$pid }'
        ";
    $bas1 = sql_fetch($sql);

    $sql = "
        select sum(gt_utp) utp
             , sum(gt_ctp) ctp
             , sum(gt_ttp) ttp
             , sum(gt_ctp) ttp_s
          from ff_game_path
         where gt_id in (select distinct gt_id
                           from ff_game_record
                          where gi_id = '{$giid}'
                            and p_id  = '{$pid }'
                        )
        ";

    $bas2 = sql_fetch($sql);

    $bas = array_merge($bas1, $bas2);

    // 비율값 산출
    $bas['tmp_sr'] = (floatval($bas['tmp']    ) == 0) ? 0 : (floatval($bas['tmp_s']) / floatval($bas['tmp']    ));
    $bas['tap_sr'] = (floatval($bas['tap']    ) == 0) ? 0 : (floatval($bas['tap_s']) / floatval($bas['tap']    ));
    $bas['ttp_sr'] = (floatval($bas['ttp']    ) == 0) ? 0 : (floatval($bas['ttp_s']) / floatval($bas['ttp']    ));
    $bas['ttp_pr'] = (floatval($bas['tap']    ) == 0) ? 0 : (floatval($bas['ttp'  ]) / floatval($bas['tap']    ));
    $bas['tmp_tr'] = (floatval($tinf['gi_tmp']) == 0) ? 0 : (floatval($bas['tmp'  ]) / floatval($tinf['gi_tmp']));
    $bas['tap_tr'] = (floatval($tinf['gi_tap']) == 0) ? 0 : (floatval($bas['tap'  ]) / floatval($tinf['gi_tap']));
    $bas['ttp_tr'] = (floatval($tinf['gi_ttp']) == 0) ? 0 : (floatval($bas['ttp'  ]) / floatval($tinf['gi_ttp']));
    $bas['sht_tr'] = (floatval($tinf['gi_sht']) == 0) ? 0 : (floatval($bas['sht_s']) / floatval($tinf['gi_sht']));
    $bas['gol_tr'] = (floatval($tinf['gi_gol']) == 0) ? 0 : (floatval($bas['gtb'  ] * 0.5
                                                                     +$bas['gtm'  ]
                                                                     +$bas['ast'  ]
                                                                     +$bas['gol'  ]) / floatval($tinf['gi_gol']));
    $bas['asr'   ] = (floatval($bas['tap']) == 0) ? 0 : (floatval($bas['tap_s']) / floatval($bas['tap']));
    $bas['ssr'   ] = (floatval($bas['sht']) == 0) ? 0 : (floatval($bas['gol'  ]) / floatval($bas['sht']));

    // 상대평가
    $rel['tap_tr'] = 100 *   floatval( $bas['tap_tr'   ]);
    $rel['tap_sr'] =  10 * ((floatval($tinf['gi_tap_sr']) == 0) ? 0 : (floatval($bas['tap_sr']) / floatval($tinf['gi_tap_sr'])));
    $rel['ttp_tr'] = 100 *   floatval( $bas['ttp_tr'   ]);
    $rel['ttp_sr'] =  10 * ((floatval($tinf['gi_ttp_sr']) == 0) ? 0 : (floatval($bas['ttp_sr']) / floatval($tinf['gi_ttp_sr'])));
    $rel['ttp_pr'] =  10 * ((floatval($tinf['gi_ttp_pr']) == 0) ? 0 : (floatval($bas['ttp_pr']) / floatval($tinf['gi_ttp_pr'])));
    $rel['sht_tr'] = 100 *   floatval( $bas['sht_tr'   ]);
    $rel['gol_tr'] =  50 *   floatval( $bas['gol_tr'   ]);

    $rel['score' ] = ( $rel['tap_tr']
                     + $rel['tap_sr']
                     + $rel['ttp_tr']
                     + $rel['ttp_sr']
                     + $rel['ttp_pr']
                     + $rel['sht_tr']
                     + $rel['gol_tr'] ) / 7;

    // 절대평가
    $BASE_TAP = (_DATA_VERSION_=='BIGDB') ? 20 : 30;
    $BASE_TTP = (_DATA_VERSION_=='BIGDB') ? 15 : 18;
    
    $abs['gol'   ] = 30 * floatval($bas['gol'   ]) +  5;
    $abs['tap'   ] = 10 * floatval($bas['tap'   ]) / $BASE_TAP;
    $abs['ttp'   ] = 10 * floatval($bas['ttp'   ]) / $BASE_TTP;
    $abs['ttp_pr'] = 10 * floatval($bas['ttp_pr']);

    $abs['score' ] = ( $abs['gol'   ]
                     + $abs['tap'   ]
                     + $abs['ttp'   ]
                     + $abs['ttp_pr'] ) / 4;

    // 종합평점
    $sql = "
        update ff_game_player
           set gp_tmp       = '{$bas['tmp'   ]}'
             , gp_tmp_sc    = '{$bas['tmp_s' ]}'
             , gp_tmp_sr    = '{$bas['tmp_sr']}'
             , gp_tmp_tr    = '{$bas['tmp_tr']}'
             , gp_tap       = '{$bas['tap'   ]}'
             , gp_tap_sc    = '{$bas['tap_s' ]}'
             , gp_tap_sr    = '{$bas['tap_sr']}'
             , gp_tap_tr    = '{$bas['tap_tr']}'
             , gp_utp       = '{$bas['utp'   ]}'
             , gp_ctp       = '{$bas['ctp'   ]}'
             , gp_ttp       = '{$bas['ttp'   ]}'
             , gp_ttp_sc    = '{$bas['ttp_s' ]}'
             , gp_ttp_sr    = '{$bas['ttp_sr']}'
             , gp_ttp_tr    = '{$bas['ttp_tr']}'
             , gp_ttp_pr    = '{$bas['ttp_pr']}'
             , gp_sht       = '{$bas['sht'   ]}'
             , gp_sht_sc    = '{$bas['sht_s' ]}'
             , gp_sht_tr    = '{$bas['sht_tr']}'
             , gp_ast       = '{$bas['ast'   ]}'
             , gp_gol       = '{$bas['gol'   ]}'
             , gp_gol_tr    = '{$bas['gol_tr']}'
             , gp_ctb       = '{$bas['ctb'   ]}'
             , gp_ctm       = '{$bas['ctm'   ]}'
             , gp_cta       = '{$bas['cta'   ]}'
             , gp_cts       = '{$bas['cts'   ]}'
             , gp_gtb       = '{$bas['gtb'   ]}'
             , gp_gtm       = '{$bas['gtm'   ]}'
             , gp_asr       = '{$bas['asr'   ]}'
             , gp_ssr       = '{$bas['ssr'   ]}'
             , gp_score_rel = '{$rel['score' ]}'
             , gp_score_abs = '{$abs['score' ]}'
         where gi_id        = '{$giid         }'
           and p_id         = '{$pid          }'
        ";

    sql_query($sql);
    
    $sql = "
        update ff_game_player
           set gp_score = ((gp_score_abs / 6) + 2)
                        + ( gp_score_rel / ((select score
                                               from (select max(gp_score_rel) score
                                                       from ff_game_player 
                                                      where gi_id = '{$giid}'
                                                    ) mm
                                            ) / 4))
         where gi_id = '{$giid}'
           and p_id  = '{$pid }'
        ";
    
    sql_query($sql);
    
    return $ret;
}

//------------------------------------------------
// DID-Play 평점 계산을 위한 경기정보 불러오기
//------------------------------------------------
function dplay_load_game_info_for_score($gi_id)
{
    global $g5;

    $sql = "
        select a.gi_id
             , b.gm_id
             , a.gi_user_id
             , a.gi_write_code
             , b.gm_h_t_code
             , b.gm_a_t_code
             , a.gi_state
             , a.gi_part
             , a.gi_formation
             , gi_h1_begin
             , gi_h2_begin
             , gi_h3_begin
             , gi_h4_begin
             , a.gi_h1_seconds
             , a.gi_h2_seconds
             , a.gi_h3_seconds
             , a.gi_h4_seconds
             , a.gi_seconds
             , b.gi_goal_home
             , b.gi_goal_away
             , a.gi_bap
             , c1.t_name gm_h_t_name
             , c2.t_name gm_a_t_name
             , b.gm_date
             , b.gm_time
             , b.gm_league
             , b.gm_league as gm_league_code
             , e.league_name as gm_league_name
             , b.gm_s_code
             , d.s_name gi_s_name
             , d.s_ground gi_s_ground
             , b.gm_round
          from ff_game b
          left outer join ff_game_info a on b.gm_id  = a.gm_id
             , ff_team      c1
             , ff_team      c2
             , ff_stadium   d
             , ff_league    e
         where a.gi_id = '{$gi_id}'
           and c1.t_code = b.gm_h_t_code
           and c2.t_code = b.gm_a_t_code
           and d.s_code = b.gm_s_code
           and e.league_code = b.gm_league
        ";

    $res = sql_query($sql);
    $lst = array();
    while ($row = sql_fetch_array($res)){
        $lst = $row;
        $lst['gp_list'] = dplay_load_game_player_for_score($row['gi_id'], $row['gi_write_code']==="H" ? $row['gm_h_t_code'] : $row['gm_a_t_code']);
        $lst['gr_list'] = dplay_load_game_record_for_score($row['gi_id']);
        $lst[] = $row;
    }
    return $lst;
}
// ------------------------------------------------
// 선수 목록
// ------------------------------------------------
function dplay_load_game_player_for_score($gi_id, $t_code)
{
    $today = date(Y.m.d);
    $sql = "
    select gp.*
         , pl.*
         , pt.*
        from ff_game_player gp
        join ff_player pl on pl.p_id = gp.p_id
        join ff_player_team pt
          on (pt.p_id = gp.p_id and t_code = '{$t_code}' )
        where gp.gi_id = '{$gi_id}'
        order by
              gp.gp_type asc
            , gp.gp_order asc
        ";

        $res = sql_query($sql);
        $lst = array();
        while ($row = sql_fetch_array($res)){
            $row['gp_player_image_url'] = G5_DATA_URL."/player/{$row['p_id']}.png";
            $lst[] = $row;
        }
        return $lst;
}

// ------------------------------------------------
// 레코드목록
// ------------------------------------------------
function dplay_load_game_record_for_score($gi_id)
{
    $sql = "
    select gr.*
        from ff_game_record gr
        where gr.gi_id = '{$gi_id}'
        order by gr_seconds asc
        ";

        $res = sql_query($sql);
        $lst = array();
        while ($row = sql_fetch_array($res)){
            $lst[] = $row;
        }
        return $lst;
}

//------------------------------------------------
// DID-Play 선수 평점 저장
//------------------------------------------------
function dplay_player_score_save($gi_id, $data)
{
    global $g5;
     $body = "";
     if ($data['tap'             ]) $body .= " , gp_tap             = '{$data['tap'             ]}' ";
     if ($data['tap_s'           ]) $body .= " , gp_tap_s           = '{$data['tap_s'           ]}' ";
     if ($data['ttp'             ]) $body .= " , gp_ttp             = '{$data['ttp'             ]}' ";

     if ($data['itm'             ]) $body .= " , gp_itm             = '{$data['itm'             ]}' ";
     if ($data['itm_s'           ]) $body .= " , gp_itm_s           = '{$data['itm_s'           ]}' ";
     if ($data['itm_r'           ]) $body .= " , gp_itm_r           = '{$data['itm_r'           ]}' ";

     if ($data['ctm'             ]) $body .= " , gp_ctm             = '{$data['ctm'             ]}' ";
     if ($data['ctm_s'           ]) $body .= " , gp_ctm_s           = '{$data['ctm_s'           ]}' ";
     if ($data['ctm_r'           ]) $body .= " , gp_ctm_r           = '{$data['ctm_r'           ]}' ";

     if ($data['utm'             ]) $body .= " , gp_utm             = '{$data['utm'             ]}' ";
     if ($data['utm_s'           ]) $body .= " , gp_utm_s           = '{$data['utm_s'           ]}' ";
     if ($data['utm_r'           ]) $body .= " , gp_utm_r           = '{$data['utm_r'           ]}' ";

     if ($data['accuracy'        ]) $body .= " , gp_accuracy        = '{$data['accuracy'        ]}' ";
     if ($data['assists'         ]) $body .= " , gp_assists         = '{$data['assists'         ]}' ";
     if ($data['shoot'           ]) $body .= " , gp_shoot           = '{$data['shoot'           ]}' ";
     if ($data['goal'            ]) $body .= " , gp_goal            = '{$data['goal'            ]}' ";

      $sql = " update ff_game_player
                  set gp_score = '{$data['score']}' $body
               where gi_id = '{$gi_id}'
                  and p_id = '{$data['p_id']}' ";

      sql_query($sql);

      dplay_player_card_save($gi_id);
      return $gi_id;
}

function dplay_player_card_save($gi_id) {

  $sql = "update ff_game_player
            set gp_yellow_card = 0,
                gp_red_card = 0
            where gi_id = '{$gi_id}'";
  sql_query($sql);

      // yellow card
       $sql = "select gp_id, count(*) cnt
                from ff_game_card
                where gi_id = '{$gi_id}'
                   and gp_card_card ='Y'
                   group by gp_id";


       $res = sql_query($sql);
       while ($row = sql_fetch_array($res)){
           $gp_id = $row['gp_id'];
           $cnt = $row['cnt'];

           $sql = "update ff_game_player
                     set gp_yellow_card = '{$cnt}'
                     where p_id = '{$gp_id}'
                      and gi_id = '{$gi_id}'";
           sql_query($sql);
       }


       // red card
        $sql = "select gp_id, count(*) cnt
                 from ff_game_card
                 where gi_id = '{$gi_id}'
                    and gp_card_card ='R'
                    group by gp_id";

        $res = sql_query($sql);
        while ($row = sql_fetch_array($res)){
            $gp_id = $row['gp_id'];
            $cnt = $row['cnt'];

            $sql = "update ff_game_player
                      set gp_red_card = '{$cnt}'
                      where p_id = '{$gp_id}'
                      and gi_id = '{$gi_id}'";
            sql_query($sql);
        }

       return $gi_id;
}

function dplay_player_card_save_commit() {
  $sql = "select gi_id
           from ff_game_info";

  $res = sql_query($sql);
  while ($row = sql_fetch_array($res)){
      dplay_player_card_save($row['gi_id']);
  }
}

function dplay_get_all_giid_by_league($league_code) {
  $sql = "select gi_id
           from ff_game_info";

   $res = sql_query($sql);
   $lst = array();
   while ($row = sql_fetch_array($res)) {
       $lst[] = $row['gi_id'];
   }

   return $lst;
}

//------------------------------------------------
// 슛 포인트 마이그레이션
//------------------------------------------------
function dplay_migration_gr_shoot_rate() {
  $sql = "update ff_game_record gr
               set gr.gr_shoot_rate_x = if(gr.gr_shoot_pos_x=0, 0, (gr.gr_shoot_pos_x - 82) / 464)
                 , gr.gr_shoot_rate_y = if(gr.gr_shoot_pos_y=0, 0, (gr.gr_shoot_pos_y - 82) / 218)
          where gr.is_old=0
  ";
  sql_fetch($sql);
}

//------------------------------------------------
// 팀 평점 마이그레이션
//------------------------------------------------
function dplay_migration_gi_team_score($gi_id, $gm_seconds=9999)
{
    $inf = array();
    $inf['gm_cnt'  ] = 1; // gm_cnt
    $inf['tap'     ] = 0; // TAP
    $inf['tap_a'   ] = 0; // TAP 평균
    $inf['tap_s'   ] = 0; // TAP 성공건수
    $inf['tap_r'   ] = 0; // TAP 성공율
    $inf['cross'   ] = 0; // 크로스
    $inf['cross_a' ] = 0; // 크로스 평균
    $inf['cross_s' ] = 0; // 크로스 성공건수
    $inf['cross_r' ] = 0; // 크로스 성공율
    $inf['pass'    ] = 0; // 패스
    $inf['pass_a'  ] = 0; // 패스 평균
    $inf['pass_s'  ] = 0; // 패스 성공건수
    $inf['pass_r'  ] = 0; // 패스 성공율
    $inf['shoot'   ] = 0; // 슛
    $inf['shoot_a' ] = 0; // 슛 평균
    $inf['shoot_s' ] = 0; // 슛 성공건수
    $inf['shoot_r' ] = 0; // 슛 성공율
    $inf['goal'    ] = 0; // 골
    $inf['goal_a'  ] = 0; // 골 평균
    $inf['itm'     ] = 0; // 전술포인트
    $inf['itm_a'   ] = 0; // 전술포인트 평균
    $inf['itm_s'   ] = 0; // 전술포인트
    $inf['ttp'     ] = 0; // 전술
    $inf['ttp_a'   ] = 0; // 전술 평균
    $inf['ctp'     ] = 0; // 전술(완결형)
    $inf['ctp_a'   ] = 0; // 전술(완결형) 평균
    $inf['utp'     ] = 0; // 전술(미완결형)
    $inf['utp_a'   ] = 0; // 전술(미완결형) 평균

    $inf['bap'     ] = 0; // bap 개수
    $inf['bap_a'   ] = 0; // bap 평균

    $inf['utm'     ] = 0; // 전술 포인트(미완결)
    $inf['utm_s'   ] = 0; // 전술 포인트(미완결) 성공개수 (B/X 제외한 확률) = utm - utp
    $inf['utr'     ] = 0; // 전술 포인트(미완결) 성공률 (B/X 제외한 확률)
    $inf['utr_a'   ] = 0; // 전술 포인트(미완결) 성공률 평균 (B/X 제외한 확률)
    $inf['ctm'     ] = 0; // 전술 포인트(완결형)
    $inf['ctm_s'   ] = 0; // 전술 포인트(완결형) 성공개수 (B/X 제외한 확률) = ctm - ctp + goal
    $inf['ctr'     ] = 0; // 전술 포인트(완결형) 성공률 (B/X 제외한 확률)
    $inf['ctr_a'   ] = 0; // 전술 포인트(완결형) 성공률 평균 (B/X 제외한 확률)

    $inf['rtp'     ] = 0; // 전술연결성 (TAP/TTP)
    $inf['gsr'     ] = 0; // 골결정력 (goal/tap*100)
    $inf['ssr'     ] = 0; // 골결정력 (goal/shoot*100)
    $inf['gat'     ] = 0; // 평균 골당 걸리는 시간 (goal/gi_seconds*100)

    $inf['team_asr'  ] = 0;
    $inf['team_score'] = 0; // 팀 평점
/*
  팀 평점 공식
    team_tap = (tap_s<180 || tap_s>220) ? 100-((200-tap_s)/1.5) : 100-((200-tap_s)/4);
    team_ctp = (ctp / 15) * 100;
    team_bap = (bap / 70) * 100;
    team_asr = 1 - ((tap - tap_s) / tap_s);
    team_shooting = (shoot / 15) * 100;
    team_goal = gaol*20 + 50;
    team_gsr = 100-(((0.012 - goal/tap_s) * 100) * 50);
    team_ssr = goal / shoot* 100 / 2 + 50;

    team_score = (teamp_tap + team_ctp + team_bap + team_asr + team_shooting + team_goal + team_gsr + team_ssr) / 8;
*/
    $sql = "select gi.gi_bap
            from ff_game_info gi
            where gi.gi_id ='{$gi_id}'
            ";
    $res = sql_query($sql);
    $records = array();
    while ($row = sql_fetch_array($res)){
        $inf['bap'] += $row['gi_bap'];
    }

    $sql = "
        select gr.*
          from ff_game_record gr
         where gr.gi_id = '{$gi_id}'
           and gr.gr_act_code is not null
           and gr.gr_act_code != ''
           and gr.gr_seconds < '{$gm_seconds}'
         order by
               gr.gi_id
             , gr.gr_seconds
             , gr.gr_regdt
        ";
    $res = sql_query($sql);

    $records = array();
    $tactics = "";
    $lastgid = "";
    $lastact = "";
    $lastsec =  0;

    while ($row = sql_fetch_array($res)){
        $records[] = $row;

        ++$inf['tap'];

        // 경기가 넘어갔거나 이전 Action에서 3초 이상 지났으면 전술 초기화
        if ($lastgid != $row['gi_id'] || $row['gr_seconds'] - $lastsec > 3){
            if($lastact && strlen($tactics) > 1){
                ++$inf['ttp'  ]; // 전술 ++
                ++$inf['utp'  ]; // 전술(미완결형) ++
                ++$inf['utp-'.((strlen($tactics)>1) ? substr($tactics,-1) : $tactics).$lastact];
                $inf['itm'] += strlen($tactics) + 1;
                $inf['utm'] += strlen($tactics) + 1;
                //echo "3:".$tactics.PHP_EOL;
            }
            $tactics = $lastact = "";
        }
        $lastsec = $row['gr_seconds'];
        $lastgid = $row['gi_id'     ];

        // Cross
        if ($row['gr_act_code'] == 'C' ||
            $row['gr_act_code'] == 'K' ||
            $row['gr_act_code'] == 'F' ){
            if ($row['gr_res_code'] != 'B' && $row['gr_res_code'] != 'X'){
                ++$inf['cross_s'];
                ++$inf['tap_s'  ];
                $tactics .= $lastact = "C";
            }
            else{
                $lastact = "";
                if(strlen($tactics) > 0){
                    ++$inf['ttp'  ]; // 전술 ++
                    ++$inf['utp'  ]; // 전술(미완결형) ++
                    ++$inf['utp-'.((strlen($tactics)>1) ? substr($tactics,-1) : $tactics)."C"];
                    $inf['itm'] += strlen($tactics);
                    $inf['itm_s'] += strlen($tactics);
                    $inf['utm'] += strlen($tactics);
                    //echo $tactics."C".PHP_EOL;
                    $tactics = "";
                }
            }
            ++$inf['cross'];
        }
        // Pass
        elseif ($row['gr_act_code'] == 'P'){
            if ($row['gr_res_code'] != 'B' && $row['gr_res_code'] != 'X'){
                ++$inf['pass_s'];
                ++$inf['tap_s' ];
                $tactics .= $lastact = "P";
            }
            else{
                $lastact = "";
                if(strlen($tactics) > 0){
                    ++$inf['ttp'  ]; // 전술 ++
                    ++$inf['utp'  ]; // 전술(미완결형) ++
                    ++$inf['utp-'.((strlen($tactics)>1) ? substr($tactics,-1) : $tactics)."P"];
                    $inf['itm'] += strlen($tactics)+1;
                    $inf['itm_s'] += strlen($tactics);
                    $inf['utm'] += strlen($tactics)+1;
                    //echo $tactics."P".PHP_EOL;
                    $tactics = "";
                }
            }
            ++$inf['pass'];
        }
        // Shoot
        elseif ($row['gr_act_code'] == 'S' ||
                $row['gr_act_code'] == 'H' ||
                $row['gr_act_code'] == 'R' ){
            if ($row['gr_res_code'] == 'G'){
                ++$inf['shoot_s'];
                ++$inf['tap_s'  ];
                ++$inf['goal'   ];
            }
            ++$inf['shoot'];
            $lastact = "S";

            if (strlen($tactics) > 0){ // 단독 슛은 전술건수에서 제외
                ++$inf['ttp'  ]; // 전술 ++
                ++$inf['ctp'  ]; // 전술(완결형) ++
                ++$inf['ctp-'.((strlen($tactics)>2) ? substr($tactics,-2) : $tactics)."S"];
                $inf['itm'] += strlen($tactics)+1;
                $inf['itm_s'] += strlen($tactics);
                $inf['ctm'] += strlen($tactics)+1;
                //echo $tactics."S".PHP_EOL;
            }
            $tactics = "";
        }
    }

    // 마지막 처리되지 않은 전술 건수
    if($lastact && strlen($tactics) > 1){
        ++$inf['ttp'  ]; // 전술 ++
        ++$inf['utp'  ]; // 전술(미완결형) ++
        ++$inf['utp-'.((strlen($tactics)>1) ? substr($tactics,-1) : $tactics).$lastact];
        $inf['itm'] += strlen($tactics) + 1;
        $inf['itm_s'] += strlen($tactics) + 1;
        $inf['utm'] += strlen($tactics) + 1;
        //echo "L:".$tactics.PHP_EOL;
    }

    $inf['utm_s'] = $inf['utm'] - $inf['utp'];
    $inf['ctm_s'] = $inf['ctm'] - $inf['ctp'] + $inf['goal'];

    // 평균
    $inf['tap_a'   ] = $inf['tap'     ] / $inf['gm_cnt'];
    $inf['cross_a' ] = $inf['cross'   ] / $inf['gm_cnt'];
    $inf['pass_a'  ] = $inf['pass'    ] / $inf['gm_cnt'];
    $inf['shoot_a' ] = $inf['shoot'   ] / $inf['gm_cnt'];
    $inf['goal_a'  ] = $inf['goal'    ] / $inf['gm_cnt'];
    $inf['itm_a'   ] = $inf['itm'     ] / $inf['gm_cnt'];
    $inf['ttp_a'   ] = $inf['ttp'     ] / $inf['gm_cnt'];
    $inf['ctp_a'   ] = $inf['ctp'     ] / $inf['gm_cnt'];
    $inf['utp_a'   ] = $inf['utp'     ] / $inf['gm_cnt'];
    $inf['ctr_a'   ] = $inf['ctr'     ] / $inf['gm_cnt'];
    $inf['utr_a'   ] = $inf['utr'     ] / $inf['gm_cnt'];
    $inf['bap_a'   ] = $inf['bap'     ] / $inf['gm_cnt'];

    // 비율산출
    $inf['tap_r'   ] = $inf['tap_s'   ] / $inf['tap'   ] * 100;
    $inf['cross_r' ] = $inf['cross_s' ] / $inf['cross' ] * 100;
    $inf['pass_r'  ] = $inf['pass_s'  ] / $inf['pass'  ] * 100;
    $inf['shoot_r' ] = $inf['shoot_s' ] / $inf['shoot' ] * 100;
    $inf['gsr'     ] = $inf['goal'    ] / $inf['tap'   ] * 100;
    $inf['ssr'     ] = $inf['goal'    ] / $inf['shoot' ] * 100;
    $inf['ctr'     ] = $inf['ctm_s'   ] / $inf['ctm'   ] * 100;
    $inf['utr'     ] = $inf['utm_s'   ] / $inf['utm'   ] * 100;
    $inf['rtp'     ] = $inf['itm'     ] / $inf['ttp'   ];

    // team score 구하기(단일 경기를 구할 때만 사용 하도록 함)
    $team_tap = ($inf['tap_s']<180 || $inf['tap_s']>220) ? 100-((200-$inf['tap_s'])/1.5) : 100-((200-$inf['tap_s'])/4);
    $team_ctp = ($inf['ctp'] / 15) * 100;
    $team_bap = ($inf['bap_a'] / 70) * 100;
    $team_asr = $inf['tap_s'] / $inf['tap'];
    $team_shooting = ($inf['shoot'] / 15) * 100;
    $team_goal = $inf['goal']*20 + 50;
    $team_gsr = 100-(((0.012 - $inf['goal']/$inf['tap_s']) * 100) * 50);
    $team_ssr = $inf['goal'] / $inf['shoot'] * 100 / 2 + 50;

    $inf['team_score'] = ($teamp_tap + $team_ctp + $team_bap + $team_asr + $team_shooting + $team_goal + $team_gsr + $team_ssr) / 8;
    $sql = "update ff_game_info gi
                 set gi.gi_team_score = {$inf['team_score']}
                   , gi.gi_team_asr = $team_asr
              where gi.gi_id = '{$gi_id}'
    ";
    sql_fetch($sql);

    return $inf['team_score']." ".$team_asr."|".$inf['tap']." ".$inf['tap_s'];
}

//
// 온에어중 시간 변경
//
function dplay_game_set_time($gi_id, $half_code, $time){
  $setQuery = "";

  $time = $time * -1000;
  if($time>0) {
    $time = "+".$time;
  }

  if($half_code=="H1") {
    $setQuery = "set gi.gi_h1_begin = gi.gi_h1_begin ".$time;
  } else if($half_code=="H2") {
    $setQuery = "set gi.gi_h2_begin = gi.gi_h2_begin ".$time;
  } else if($half_code=="H3") {
    $setQuery = "set gi.gi_h3_begin = gi.gi_h3_begin ".$time;
  } else if($half_code=="H4") {
    $setQuery = "set gi.gi_h4_begin = gi.gi_h4_begin ".$time;
  }

  $sql = "update ff_game_info gi
            {$setQuery}
          where gi.gi_id = '{$gi_id}'
         ";
  sql_fetch($sql);

  return dplay_game_info($gi_id);
}

//
// 패스/크로스 좌표 마이그레이션 unused
//
function dplay_migration_gr_part_pos() {
    $sql = "select gr.*
            from ff_game_record gr
              join ff_game_info gi on gi.gi_id = gr.gi_id
            where (gi.gi_part = 'L' and gr.gr_half = 'H1')
                or(gi.gi_part = 'R' and gr.gr_half = 'H2')
           ";
    $res = sql_query($sql);
    $lst = array();
    while($row = sql_fetch_array($res)) {
      dplay_migration_gr_part_pos_calc_l($row['gr_id']);
    }

    $sql = "select gr.*
            from ff_game_record gr
              join ff_game_info gi on gi.gi_id = gr.gi_id
            where (gi.gi_part = 'R' and gr.gr_half = 'H1')
                or(gi.gi_part = 'L' and gr.gr_half = 'H2')
           ";
    $res = sql_query($sql);
    $lst = array();
    while($row = sql_fetch_array($res)) {
      dplay_migration_gr_part_pos_calc_r($row['gr_id']);
    }

    return 1;
}

function dplay_migration_gr_part_pos_calc_l($gr_id) {
  /*
            x = (float) posY / (float) cy;
            y = (float) (cx - posX) / (float) cx;
  */
  $sql = "update ff_game_record gr
               set gr.gr_part_pos_x = (22 + gr.gr_pos_y) / 634
                 , gr.gr_part_pos_y = (485*2 - (22+gr.gr_pos_x)) / 485
            where gr.gr_id = '{$gr_id}'
  ";
  sql_fetch($sql);
}

function dplay_migration_gr_part_pos_calc_r($gr_id) {
  /*
            x = (float) (cy - posY) / (float) cy;
            y = (float) posX / (float) cx;
  */
  //
  // gr.gr_part_pos_x = (612 - gr.gr_pos_y) / 612
  //                  , gr.gr_part_pos_y = (gr.gr_pos_x) / 453
  $sql = "update ff_game_record gr
               set gr.gr_part_pos_x = (634 - (22+gr.gr_pos_y)) / (634)
                 , gr.gr_part_pos_y = (22 + gr.gr_pos_x) / 485
            where gr.gr_id = '{$gr_id}'
  ";


    sql_fetch($sql);
}

function dplay_migration_load_gi_id_list($league_code) {
  if($league_code==null) {
    $league_sql = "";
  } else {
    $league_sql = "and gm.gm_league = '{$league_code}'";
  }
  $sql = "select gi.gi_id
          from ff_game_info gi
            join ff_game gm on gm.gm_id = gi.gm_id
          where gm.gm_state = 'END'

  ";
  $res = sql_query($sql);
  $lst = array();
  while($row = sql_fetch_array($res)) {
    $lst[] = $row['gi_id'];
  }

  return $lst;
}
